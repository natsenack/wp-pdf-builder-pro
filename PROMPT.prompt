# PDF Builder Pro - Guide de D√©veloppement et Production

## üìã Vue d'ensemble

**PDF Builder Pro** est un plugin WordPress ultra-performant pour la g√©n√©ration de PDF avec une architecture modulaire avanc√©e. Il comprend un √©diteur React, des int√©grations WooCommerce, et un syst√®me de cache unifi√©.

## üèóÔ∏è Architecture du Plugin

### Structure Principale

```
wp-pdf-builder-pro/
‚îú‚îÄ‚îÄ plugin/                          # Noyau du plugin
‚îÇ   ‚îú‚îÄ‚îÄ pdf-builder-pro.php         # Point d'entr√©e principal
‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.php               # Chargement diff√©r√© des fonctionnalit√©s
‚îÇ   ‚îú‚îÄ‚îÄ composer.json               # D√©pendances PHP
‚îÇ   ‚îú‚îÄ‚îÄ vendor/                     # Librairies externes (DomPDF, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ src/                        # Code source PHP
‚îÇ   ‚îú‚îÄ‚îÄ assets/                     # Assets compil√©s (JS/CSS)
‚îÇ   ‚îî‚îÄ‚îÄ resources/                  # Templates et assets statiques
‚îú‚îÄ‚îÄ assets/                         # Assets source (TypeScript/React)
‚îú‚îÄ‚îÄ build/                          # Scripts de d√©ploiement
‚îú‚îÄ‚îÄ docs/                           # Documentation
‚îî‚îÄ‚îÄ tests/                          # Tests unitaires et d'int√©gration
```

### Architecture Modulaire

#### 1. **Couche Admin** (`src/Admin/`)
- **PdfBuilderAdmin** : Classe principale d'administration
- **SettingsManager** : Gestion des param√®tres
- **AjaxHandler** : Gestion des appels AJAX
- **TemplateManager** : Gestion des templates
- **Permissions/Validation** : Utilitaires s√©curit√©

#### 2. **Couche Core** (`src/Core/`)
- **PDF_Builder_Core** : Noyau central
- **PDF_Builder_Ajax_Handler** : Handler AJAX unifi√©
- **PDF_Builder_Cache_Manager** : Syst√®me de cache centralis√©
- **PDF_Builder_Task_Scheduler** : Planificateur de t√¢ches
- **PDF_Builder_Health_Monitor** : Monitoring syst√®me

#### 3. **Managers Sp√©cialis√©s** (`src/Managers/`)
- **PDF_Builder_Template_Manager** : Gestion templates
- **PDF_Builder_PDF_Generator** : G√©n√©ration PDF
- **PDF_Builder_Asset_Optimizer** : Optimisation assets
- **PDF_Builder_Cache_Manager** : Cache unifi√©
- **PDF_Builder_WooCommerce_Integration** : Int√©gration WooCommerce

#### 4. **Couche Frontend** (`assets/`)
- **React Components** : √âditeur visuel
- **TypeScript** : Logique m√©tier
- **Canvas API** : Rendu des √©l√©ments
- **AjaxCompat** : Communication client/serveur

## üöÄ Fonctions Principales

### √âditeur PDF (React)
```javascript
// Initialisation de l'√©diteur
window.initPDFBuilderReact(container, options);

// Gestion du canvas
const canvas = new Canvas(width, height);
canvas.addElement(element);
canvas.render();

// Gestion des templates
useTemplate().loadTemplate(templateId);
useTemplate().saveTemplate(data);
```

### G√©n√©ration PDF
```php
// G√©n√©ration depuis canvas
$pdfGenerator = new PDF_Builder_PDF_Generator();
$pdf = $pdfGenerator->generateFromCanvas($canvasData);

// G√©n√©ration depuis template
$templateManager = new PDF_Builder_Template_Manager();
$pdf = $templateManager->generatePDF($templateId, $data);
```

### Cache Unifi√©
```php
// Utilisation du cache centralis√©
$cache = PDF_Builder_Cache_Manager::getInstance();
$cache->set('key', 'value', 'transient', 3600);
$value = $cache->get('key', 'transient');

// Cache sp√©cialis√©
$cache->setAssetCache('style.css', $css, 'css');
$cache->setAjaxCache('action', $params, $result);
```

### Int√©gration WooCommerce
```php
// G√©n√©ration automatique de factures
$wcIntegration = new PDF_Builder_WooCommerce_Integration();
$wcIntegration->generateOrderPDF($orderId, $templateId);

// Gestion des statuts de commande
$wcIntegration->handleOrderStatusChange($orderId, $newStatus);
```

### API REST
```php
// Endpoints disponibles
GET  /wp-json/pdf-builder/v1/templates
POST /wp-json/pdf-builder/v1/templates
GET  /wp-json/pdf-builder/v1/preview/{template_id}
POST /wp-json/pdf-builder/v1/generate
```

## ‚öôÔ∏è Configuration et Param√®tres

### Param√®tres WordPress (`wp_options`)
```php
'pdf_builder_settings' => [
    // Cache
    'pdf_builder_cache_enabled' => true,
    'pdf_builder_cache_ttl' => 3600,
    'pdf_builder_asset_cache_enabled' => true,

    // Templates
    'pdf_builder_default_template' => 'facture',
    'pdf_builder_template_limit' => 50,

    // PDF
    'pdf_builder_pdf_quality' => 85,
    'pdf_builder_pdf_compression' => true,

    // S√©curit√©
    'pdf_builder_enable_debug' => false,
    'pdf_builder_file_validation' => true,

    // Performance
    'pdf_builder_memory_limit' => 256,
    'pdf_builder_max_execution_time' => 30
]
```

### Constantes du Plugin
```php
define('PDF_BUILDER_PLUGIN_FILE', __FILE__);
define('PDF_BUILDER_PLUGIN_DIR', dirname(__FILE__) . '/');
define('PDF_BUILDER_PLUGIN_URL', plugin_dir_url(__FILE__));
define('PDF_BUILDER_VERSION', '1.1.0');
define('PDF_BUILDER_PREMIUM', false); // Version gratuite
```

## üóÉÔ∏è Base de Donn√©es

### Tables Cr√©√©es
```sql
-- Templates utilisateur
wp_pdf_builder_templates (
    id, name, template_data, user_id,
    is_default, created_at, updated_at
)

-- Logs du syst√®me
wp_pdf_builder_logs (
    id, log_message, created_at
)

-- Int√©gration WooCommerce
wp_pdf_builder_orders (
    id, order_id, template_id, pdf_path, created_at
)
```

### Transients WordPress
```php
// Cache du plugin
'pdf_builder_cache_*'          // Cache g√©n√©ral
'pdf_builder_ajax_*'           // Cache AJAX
'pdf_builder_asset_*'          // Cache assets
'pdf_builder_rate_limit_*'     // Limitation taux
```

## üîß Actions et Filtres WordPress

### Actions
```php
// Initialisation
add_action('plugins_loaded', 'pdf_builder_init');
add_action('init', 'pdf_builder_register_post_types');

// Admin
add_action('admin_menu', 'pdf_builder_add_menu');
add_action('admin_enqueue_scripts', 'pdf_builder_enqueue_assets');

// AJAX
add_action('wp_ajax_pdf_builder_save_template', 'pdf_builder_ajax_save');
add_action('wp_ajax_pdf_builder_generate_pdf', 'pdf_builder_ajax_generate');

// WooCommerce
add_action('woocommerce_order_status_changed', 'pdf_builder_order_status_changed');
```

### Filtres
```php
// Templates
apply_filters('pdf_builder_available_templates', $templates);
apply_filters('pdf_builder_template_data', $data, $template_id);

// PDF Generation
apply_filters('pdf_builder_pdf_options', $options);
apply_filters('pdf_builder_pdf_content', $content, $data);

// Assets
apply_filters('pdf_builder_enqueue_scripts', $scripts);
apply_filters('pdf_builder_enqueue_styles', $styles);
```

## üåê API JavaScript

### Fonctions Globales
```javascript
// Cache
window.pdfBuilderCheckCSS()          // V√©rifier cache CSS
window.pdfBuilderCheckJSCache()      // V√©rifier cache JS
window.pdfBuilderEmergencyFix()      // Correction d'urgence

// √âditeur
window.initPDFBuilderReact()         // Initialiser l'√©diteur React
window.pdfBuilderForceReload()       // Forcer rechargement

// Debug
window.canvasMemoryDebug.getCacheStats() // Stats cache canvas
```

### Classes JavaScript
```javascript
// Gestion AJAX
window.AjaxCompat.request(action, data, options)

// Gestion canvas
const canvas = new Canvas(width, height);
canvas.addElement(element);
canvas.exportToPDF();

// Gestion templates
useTemplate().loadTemplate(id);
useTemplate().saveTemplate(data);
```

## üì¶ D√©ploiement et Production

### Scripts de Build
```bash
# Compilation des assets
npm run build          # Production
npm run dev           # D√©veloppement
npm run watch         # Surveillance

# Tests
npm run test          # Tests unitaires
npm run test:coverage # Tests avec couverture
```

### D√©ploiement FTP
```powershell
# Test (simulation)
.\build\deploy-simple.ps1

# Production (recommand√©)
.\build\deploy-simple.ps1

# D√©ploiement complet
.\build\deploy-all.ps1
```

### Variables d'Environnement

#### Production
```php
// Configuration production
define('WP_DEBUG', false);
define('WP_DEBUG_LOG', false);
define('PDF_BUILDER_PRODUCTION', true);
error_reporting(0);
```

#### D√©veloppement
```php
// Configuration d√©veloppement
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
define('PDF_BUILDER_DEVELOPMENT', true);
error_reporting(E_ALL);
```

## üîí R√®gles de S√©curit√©

### Validation des Donn√©es
```php
// Toujours utiliser les fonctions WordPress
$safe_value = sanitize_text_field($_POST['field']);
$safe_email = sanitize_email($_POST['email']);
$safe_html = wp_kses($_POST['html'], $allowed_tags);
```

### Nonces WordPress
```php
// G√©n√©ration
$nonce = wp_create_nonce('pdf_builder_action');

// V√©rification
if (!wp_verify_nonce($_POST['nonce'], 'pdf_builder_action')) {
    wp_die('Nonce invalide');
}
```

### Permissions
```php
// V√©rification des droits
if (!current_user_can('manage_options')) {
    wp_die('Acc√®s refus√©');
}
```

### Stockage Client Interdit
```javascript
// üö´ STRICTEMENT INTERDIT : localStorage, sessionStorage
// Ces APIs ne doivent JAMAIS √™tre utilis√©es dans ce projet

// INTERDIT ‚ùå
localStorage.setItem('pdf_builder_settings', data);
sessionStorage.setItem('temp_data', value);
indexedDB.open('pdf_builder_db');

// AUTORIS√â ‚úÖ
// Utiliser uniquement les options WordPress
update_option('pdf_builder_settings', $data);

// Ou le syst√®me de cache centralis√©
PDF_Builder_Cache_Manager::set('key', $value, 'group');
```

**Raison :** Le localStorage/sessionStorage n'est pas s√©curis√© c√¥t√© serveur et peut √™tre manipul√© par les utilisateurs. Toutes les donn√©es doivent √™tre stock√©es c√¥t√© serveur via l'API WordPress.

### √âchappement des Sorties
```php
// PHP
echo esc_html($variable);
echo esc_url($url);
echo esc_attr($attribute);

// JavaScript
wp_localize_script('script', 'pdfBuilderData', [
    'ajaxUrl' => esc_url(admin_url('admin-ajax.php')),
    'nonce' => wp_create_nonce('pdf_builder_ajax')
]);
```

### JavaScript/React
```javascript
// ‚ùå INTERDIT : Ne pas utiliser localStorage
// localStorage.setItem('key', 'value'); // INTERDIT !

// ‚úÖ CORRECT : Utiliser les options WordPress ou AJAX
wp_localize_script('script', 'pdfBuilderData', $data);

// ‚úÖ CORRECT : Utiliser le syst√®me de cache centralis√© c√¥t√© serveur
PDF_Builder_Cache_Manager::set('key', $value);
```

## üéØ Bonnes Pratiques

### PHP
```php
// Utiliser les classes du plugin
use PDF_Builder\Managers\PDF_Builder_Cache_Manager;
use PDF_Builder\Admin\PdfBuilderAdmin;

// Singleton pattern
$cache = PDF_Builder_Cache_Manager::getInstance();

// Gestion d'erreurs
try {
    // Code
} catch (Exception $e) {
    error_log('PDF Builder Error: ' . $e->getMessage());
    wp_send_json_error('Erreur serveur');
}
```

### JavaScript
```javascript
// Async/await pour les appels AJAX
async function loadTemplate(templateId) {
    try {
        const response = await AjaxCompat.request('get_template', {id: templateId});
        if (response.success) {
            // Traiter la r√©ponse
        }
    } catch (error) {
        console.error('Erreur chargement template:', error);
    }
}

// Gestion m√©moire canvas
const imageCache = useRef(new Map());
cleanupImageCache(); // Nettoyage automatique
```

### Base de Donn√©es
```php
// Pr√©parer les requ√™tes
global $wpdb;
$table = $wpdb->prefix . 'pdf_builder_templates';

$query = $wpdb->prepare(
    "SELECT * FROM $table WHERE id = %d AND user_id = %d",
    $template_id,
    get_current_user_id()
);

$result = $wpdb->get_row($query);
```

## üß™ Tests

### Tests PHP (PHPUnit)
```bash
# Ex√©cuter tous les tests
./vendor/bin/phpunit

# Tests sp√©cifiques
./vendor/bin/phpunit tests/AjaxHandlerTest.php
```

### Tests JavaScript (Jest)
```bash
# Tests unitaires
npm run test

# Tests avec couverture
npm run test:coverage

# Tests canvas sp√©cifiques
npm run test:canvas
```

## üìä Monitoring et Logs

### Logs PHP
```php
// Log d'information
error_log('[PDF Builder] Template loaded: ' . $template_id);

// Log de debug (uniquement en d√©veloppement)
if (WP_DEBUG) {
    error_log('[PDF Builder Debug] Canvas data: ' . print_r($canvas_data, true));
}
```

### Logs JavaScript
```javascript
// Logs console
console.log('[PDF Builder] Canvas rendered in', duration, 'ms');

// Logs d'erreur
console.error('[PDF Builder] Failed to load template:', error);
```

### M√©triques Performance
```php
// Temps d'ex√©cution
$start_time = microtime(true);
// ... code ...
$duration = microtime(true) - $start_time;
error_log('[PDF Builder] PDF generated in ' . round($duration, 3) . 's');
```

## üö® R√®gles de Production

### ‚úÖ DO
- ‚úÖ Tester toujours en d√©veloppement avant production
- ‚úÖ Utiliser les scripts de d√©ploiement (`deploy-simple.ps1`)
- ‚úÖ V√©rifier les logs apr√®s d√©ploiement
- ‚úÖ Sauvegarder la base de donn√©es avant les changements majeurs
- ‚úÖ Utiliser les nonces WordPress pour la s√©curit√©
- ‚úÖ Valider et √©chapper toutes les donn√©es utilisateur
- ‚úÖ Utiliser le cache centralis√© pour les performances

### ‚ùå DON'T
- ‚ùå Modifier directement les fichiers en production
- ‚ùå D√©sactiver les logs d'erreur en production
- ‚ùå Utiliser `var_dump()` ou `print_r()` en production
- ‚ùå Commiter des mots de passe ou cl√©s API
- ‚ùå Supprimer les v√©rifications de s√©curit√©
- ‚ùå Utiliser des requ√™tes SQL non pr√©par√©es
- ‚ùå Utiliser le localStorage du navigateur

### üîß Commandes de Maintenance
```bash
# Vider tous les caches
wp eval "PDF_Builder_Cache_Manager::clearCache();"

# R√©g√©n√©rer les assets
npm run build && deploy-simple.ps1

# V√©rifier l'int√©grit√©
wp pdf-builder check-integrity

# Nettoyer les transients expir√©s
wp eval "global \$wpdb; \$wpdb->query(\"DELETE FROM {\$wpdb->options} WHERE option_name LIKE '_transient_pdf_builder_%'\");"
```

## üìö Ressources Utiles

### Fichiers de Configuration
- `build/deploy-simple.ps1` - Script de d√©ploiement
- `webpack.config.cjs` - Configuration build
- `composer.json` - D√©pendances PHP
- `package.json` - D√©pendances JS

### Documentation
- `docs/CACHE_SYSTEM.md` - Syst√®me de cache
- `docs/API_REFERENCE.md` - R√©f√©rence API
- `CHANGELOG.md` - Historique des versions

### Points d'Entr√©e
- `pdf-builder-pro.php` - Plugin principal
- `bootstrap.php` - Chargement initial
- `src/Admin/PdfBuilderAdmin.php` - Interface admin
- `assets/js/pdf-builder-react/index.js` - √âditeur React

---

**Version du Plugin** : 1.1.0
**Derni√®re mise √† jour** : D√©cembre 2025
**Auteur** : Natsenack
**Compatibilit√©** : WordPress 5.0+, PHP 7.4+
