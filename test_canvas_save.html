<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Canvas Settings Save</title>
</head>
<body>
    <h1>Test de sauvegarde des paramètres canvas</h1>

    <div id="test-results">
        <p>Ouvrez la console du navigateur (F12) pour voir les résultats du test.</p>
    </div>

    <!-- Simuler les champs de formulaire canvas -->
    <form id="canvas-settings-form">
        <label for="canvas_max_size">Taille max canvas:</label>
        <input type="number" id="canvas_max_size" name="canvas_max_size" value="10000"><br>

        <label for="canvas_dpi">DPI:</label>
        <input type="number" id="canvas_dpi" name="canvas_dpi" value="300"><br>

        <label for="canvas_format">Format:</label>
        <select id="canvas_format" name="canvas_format">
            <option value="png" selected>PNG</option>
            <option value="jpg">JPG</option>
            <option value="svg">SVG</option>
        </select><br>

        <label for="canvas_quality">Qualité:</label>
        <input type="number" id="canvas_quality" name="canvas_quality" value="90"><br>

        <!-- Simuler le nonce -->
        <input type="hidden" name="pdf_builder_settings_nonce" value="test_nonce_123">
    </form>

    <button onclick="runTest()">Lancer le test</button>

    <script>
        // Simuler l'objet pdfBuilderAjax
        window.pdfBuilderAjax = {
            ajax_url: 'http://localhost/wp-admin/admin-ajax.php'
        };

        // Fonction de test
        function runTest() {
            console.log('=== Test de sauvegarde des paramètres canvas ===');

            // Récupérer les valeurs des champs
            const canvasMaxSize = document.getElementById('canvas_max_size').value;
            const canvasDpi = document.getElementById('canvas_dpi').value;
            const canvasFormat = document.getElementById('canvas_format').value;
            const canvasQuality = document.getElementById('canvas_quality').value;

            console.log('Valeurs du formulaire:');
            console.log('- canvas_max_size:', canvasMaxSize);
            console.log('- canvas_dpi:', canvasDpi);
            console.log('- canvas_format:', canvasFormat);
            console.log('- canvas_quality:', canvasQuality);

            // Simuler la fonction saveCanvasSettingsToServer
            console.log('Simulation de saveCanvasSettingsToServer()...');

            const formData = new FormData();
            formData.append('action', 'pdf_builder_save_settings');
            formData.append('tab', 'contenu');
            formData.append('canvas_max_size', canvasMaxSize);
            formData.append('canvas_dpi', canvasDpi);
            formData.append('canvas_format', canvasFormat);
            formData.append('canvas_quality', canvasQuality);
            formData.append('pdf_builder_settings_nonce', 'test_nonce_123');

            console.log('Données FormData préparées pour AJAX');

            // Simuler une réponse réussie (puisque nous ne pouvons pas faire de vrai appel AJAX)
            const mockResponse = {
                success: true,
                data: {
                    message: 'Paramètres sauvegardés avec succès',
                    saved_count: 4,
                    saved_settings: {
                        canvas_max_size: parseInt(canvasMaxSize),
                        canvas_dpi: parseInt(canvasDpi),
                        canvas_format: canvasFormat,
                        canvas_quality: parseInt(canvasQuality),
                        template_library_enabled: '1',
                        default_template: 'blank'
                    },
                    new_nonce: 'new_test_nonce_456'
                }
            };

            console.log('Réponse simulée:', mockResponse);

            if (mockResponse.success) {
                console.log('✅ Test réussi - sauvegarde simulée réussie!');
                const savedSettings = mockResponse.data.saved_settings;

                if (savedSettings.canvas_max_size !== undefined &&
                    savedSettings.canvas_dpi !== undefined &&
                    savedSettings.canvas_format !== undefined &&
                    savedSettings.canvas_quality !== undefined) {
                    console.log('✅ Tous les paramètres canvas sont présents dans saved_settings');
                    document.getElementById('test-results').innerHTML = '<p style="color: green;">✅ Test réussi ! Tous les paramètres canvas sont correctement sauvegardés.</p>';
                } else {
                    console.log('❌ Certains paramètres canvas manquent');
                    document.getElementById('test-results').innerHTML = '<p style="color: red;">❌ Test échoué ! Certains paramètres manquent.</p>';
                }
            } else {
                console.log('❌ Test échoué - réponse d\'erreur');
                document.getElementById('test-results').innerHTML = '<p style="color: red;">❌ Test échoué ! Réponse d\'erreur.</p>';
            }
        }
    </script>
</body>
</html>