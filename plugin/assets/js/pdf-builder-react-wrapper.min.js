/**
 * PDF Builder React Wrapper - V1 REPLICA WITH WORKING DRAG & DROP
 */

(function() {
  'use strict';

  console.log('[PDF Builder] React Wrapper initializing - V1 with Drag & Drop');

  if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') {
    console.error('[PDF Builder] React or ReactDOM not available');
    return;
  }

  window.pdfBuilderReact = {
    initPDFBuilderReact: function(config) {
      console.log('[PDF Builder] initPDFBuilderReact called');
      
      const container = document.getElementById('pdf-builder-react-root');
      if (!container) {
        console.error('[PDF Builder] Container not found');
        return false;
      }

      const canvasConfig = {
        format: 'A4',
        width: 595,
        height: 842,
        dpi: 72,
        orientation: 'portrait',
        templateName: 'Nouveau Template',
        ...config
      };

      // State management
      let draggedElement = null;
      let canvasElements = [];
      let selectedElementId = null;

      // ========== HEADER ==========
      const Header = function() {
        return window.React.createElement('div', {
          style: {
            position: 'sticky',
            top: 0,
            zIndex: 1000,
            backgroundColor: '#2c3e50',
            color: 'white',
            padding: '12px 20px',
            borderBottom: '1px solid #1a252f',
            boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            gap: '16px'
          }
        },
          window.React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', flex: 1 } },
            window.React.createElement('h1', { style: { margin: 0, fontSize: '18px', fontWeight: 600 } }, ' ' + canvasConfig.templateName),
            window.React.createElement('span', { style: { fontSize: '12px', color: '#bbb' } }, 'Format: ' + canvasConfig.format + ' (' + canvasConfig.width + 'x' + canvasConfig.height + 'px)')
          ),
          window.React.createElement('div', { style: { display: 'flex', gap: '8px' } },
            window.React.createElement('button', {
              onClick: function() { console.log('[PDF Builder] Save clicked'); },
              style: {
                padding: '8px 16px',
                backgroundColor: '#27ae60',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: 500
              }
            }, ' Enregistrer'),
            window.React.createElement('button', {
              onClick: function() { console.log('[PDF Builder] Preview clicked'); },
              style: {
                padding: '8px 16px',
                backgroundColor: '#3498db',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: 500
              }
            }, ' Aperçu'),
            window.React.createElement('button', {
              onClick: function() { console.log('[PDF Builder] Settings clicked'); },
              style: {
                padding: '8px 16px',
                backgroundColor: '#95a5a6',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: 500
              }
            }, ' Paramètres')
          )
        );
      };

      // ========== TOOLBAR HEADER ==========
      const ToolbarHeader = function() {
        return window.React.createElement('div', {
          style: {
            backgroundColor: '#ecf0f1',
            borderBottom: '1px solid #bdc3c7',
            padding: '8px 12px',
            display: 'flex',
            gap: '4px',
            alignItems: 'center',
            flexWrap: 'wrap'
          }
        },
          window.React.createElement('button', { title: 'Défaire (Ctrl+Z)', style: { padding: '6px 10px', backgroundColor: '#fff', border: '1px solid #bdc3c7', borderRadius: '3px', cursor: 'pointer', fontSize: '12px' } }, ' Défaire'),
          window.React.createElement('button', { title: 'Refaire (Ctrl+Y)', style: { padding: '6px 10px', backgroundColor: '#fff', border: '1px solid #bdc3c7', borderRadius: '3px', cursor: 'pointer', fontSize: '12px' } }, ' Refaire'),
          window.React.createElement('div', { style: { width: '1px', height: '20px', backgroundColor: '#bdc3c7', margin: '0 4px' } }),
          window.React.createElement('button', { title: 'Sélection', style: { padding: '6px 10px', backgroundColor: '#3498db', color: 'white', border: 'none', borderRadius: '3px', cursor: 'pointer', fontSize: '12px' } }, ' Sélection'),
          window.React.createElement('button', { title: 'Ajouter du texte', style: { padding: '6px 10px', backgroundColor: '#fff', border: '1px solid #bdc3c7', borderRadius: '3px', cursor: 'pointer', fontSize: '12px' } }, 'T Texte'),
          window.React.createElement('button', { title: 'Ajouter une image', style: { padding: '6px 10px', backgroundColor: '#fff', border: '1px solid #bdc3c7', borderRadius: '3px', cursor: 'pointer', fontSize: '12px' } }, ' Image'),
          window.React.createElement('button', { title: 'Dessiner un rectangle', style: { padding: '6px 10px', backgroundColor: '#fff', border: '1px solid #bdc3c7', borderRadius: '3px', cursor: 'pointer', fontSize: '12px' } }, ' Rectangle'),
          window.React.createElement('button', { title: 'Dessiner un cercle', style: { padding: '6px 10px', backgroundColor: '#fff', border: '1px solid #bdc3c7', borderRadius: '3px', cursor: 'pointer', fontSize: '12px' } }, ' Cercle'),
          window.React.createElement('button', { title: 'Tracer une ligne', style: { padding: '6px 10px', backgroundColor: '#fff', border: '1px solid #bdc3c7', borderRadius: '3px', cursor: 'pointer', fontSize: '12px' } }, ' Ligne'),
          window.React.createElement('div', { style: { width: '1px', height: '20px', backgroundColor: '#bdc3c7', margin: '0 4px' } }),
          window.React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px', cursor: 'pointer' } },
            window.React.createElement('input', { type: 'checkbox', defaultChecked: true, style: { cursor: 'pointer' } }),
            ' Afficher grille'
          ),
          window.React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px', cursor: 'pointer' } },
            window.React.createElement('input', { type: 'checkbox', defaultChecked: true, style: { cursor: 'pointer' } }),
            ' Repères'
          )
        );
      };

      // ========== ELEMENT LIBRARY ==========
      const ElementLibrary = function() {
        const elements = [
          { icon: '', label: 'Texte Dynamique', type: 'dynamic_text' },
          { icon: '', label: 'Tableau Produits', type: 'product_table' },
          { icon: '', label: 'Fiche Client', type: 'customer_info' },
          { icon: '[D]', label: 'Infos Entreprise', type: 'company_info' },
          { icon: '', label: 'Logo Entreprise', type: 'company_logo' },
          { icon: '', label: 'Numéro Commande', type: 'order_number' },
          { icon: '', label: 'Type Document', type: 'document_type' },
          { icon: 'T', label: 'Texte Simple', type: 'text' },
          { icon: '', label: 'Rectangle', type: 'rectangle' },
          { icon: '', label: 'Cercle', type: 'circle' },
          { icon: '', label: 'Ligne', type: 'line' },
          { icon: '', label: 'Image', type: 'image' }
        ];

        return window.React.createElement('div', {
          style: {
            width: '220px',
            backgroundColor: '#ffffff',
            borderRight: '1px solid #e0e0e0',
            overflow: 'auto',
            display: 'flex',
            flexDirection: 'column'
          }
        },
          window.React.createElement('div', { style: { padding: '12px', borderBottom: '1px solid #e0e0e0', fontWeight: 600, fontSize: '13px' } }, ' Éléments'),
          window.React.createElement('div', { style: { flex: 1, overflow: 'auto', padding: '8px' } },
            elements.map(function(el, idx) {
              return window.React.createElement('div', {
                key: idx,
                draggable: true,
                onDragStart: function(e) {
                  draggedElement = el;
                  e.dataTransfer.effectAllowed = 'copy';
                  e.dataTransfer.setData('text/plain', JSON.stringify(el));
                  console.log('[PDF Builder] Drag started:', el.type);
                },
                onDragEnd: function() {
                  draggedElement = null;
                  console.log('[PDF Builder] Drag ended');
                },
                style: {
                  padding: '10px',
                  marginBottom: '6px',
                  backgroundColor: '#f8f9fa',
                  border: '1px solid #e0e0e0',
                  borderRadius: '4px',
                  cursor: 'move',
                  fontSize: '12px',
                  transition: 'all 0.2s',
                  userSelect: 'none'
                }
              },
                window.React.createElement('div', { style: { fontSize: '16px', marginBottom: '4px' } }, el.icon),
                window.React.createElement('div', { style: { fontWeight: 500, color: '#333' } }, el.label),
                window.React.createElement('div', { style: { fontSize: '10px', color: '#999', marginTop: '2px' } }, 'Glisser sur canvas')
              );
            })
          )
        );
      };

      // ========== CANVAS WITH DRAG & DROP ==========
      const Canvas = function() {
        const handleDragOver = function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          const canvas = e.currentTarget;
          canvas.style.backgroundColor = '#d0d0d0';
          console.log('[PDF Builder] Drag over canvas');
        };

        const handleDragLeave = function(e) {
          if (e.currentTarget === e.target) {
            e.currentTarget.style.backgroundColor = '#d8d8d8';
          }
        };

        const handleDrop = function(e) {
          e.preventDefault();
          e.currentTarget.style.backgroundColor = '#d8d8d8';

          if (!draggedElement) return;

          const canvas = document.getElementById('pdf-canvas');
          if (!canvas) return;

          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // Créer un nouvel élément
          const newElement = {
            id: 'element_' + Date.now(),
            type: draggedElement.type,
            x: Math.max(0, x - 50),
            y: Math.max(0, y - 25),
            width: 100,
            height: 50,
            text: draggedElement.label
          };

          canvasElements.push(newElement);
          console.log('[PDF Builder] Element dropped:', newElement);

          // Créer un élément visuel sur le canvas
          const elementDiv = document.createElement('div');
          elementDiv.id = newElement.id;
          elementDiv.draggable = true;
          elementDiv.style.position = 'absolute';
          elementDiv.style.left = newElement.x + 'px';
          elementDiv.style.top = newElement.y + 'px';
          elementDiv.style.width = newElement.width + 'px';
          elementDiv.style.height = newElement.height + 'px';
          elementDiv.style.backgroundColor = '#fff';
          elementDiv.style.border = '2px solid #007bff';
          elementDiv.style.borderRadius = '4px';
          elementDiv.style.cursor = 'move';
          elementDiv.style.padding = '8px';
          elementDiv.style.boxSizing = 'border-box';
          elementDiv.style.fontSize = '12px';
          elementDiv.style.textAlign = 'center';
          elementDiv.style.display = 'flex';
          elementDiv.style.alignItems = 'center';
          elementDiv.style.justifyContent = 'center';
          elementDiv.textContent = draggedElement.icon + ' ' + draggedElement.label;

          elementDiv.onclick = function(e) {
            e.stopPropagation();
            selectedElementId = newElement.id;
            document.querySelectorAll('[id^="element_"]').forEach(function(el) {
              el.style.borderColor = '#d0d0d0';
            });
            elementDiv.style.borderColor = '#dc3545';
            console.log('[PDF Builder] Element selected:', newElement.id);
          };

          elementDiv.ondragstart = function(e) {
            e.dataTransfer.effectAllowed = 'move';
            const startX = e.clientX;
            const startY = e.clientY;
            const startLeft = parseInt(elementDiv.style.left) || 0;
            const startTop = parseInt(elementDiv.style.top) || 0;

            document.onmousemove = function(moveEvent) {
              const deltaX = moveEvent.clientX - startX;
              const deltaY = moveEvent.clientY - startY;
              elementDiv.style.left = (startLeft + deltaX) + 'px';
              elementDiv.style.top = (startTop + deltaY) + 'px';
            };

            document.onmouseup = function() {
              document.onmousemove = null;
              document.onmouseup = null;
              const newElement = canvasElements.find(function(el) { return el.id === newElement.id; });
              if (newElement) {
                newElement.x = parseInt(elementDiv.style.left) || 0;
                newElement.y = parseInt(elementDiv.style.top) || 0;
                console.log('[PDF Builder] Element moved:', newElement);
              }
            };
          };

          canvas.appendChild(elementDiv);
        };

        return window.React.createElement('div', {
          style: {
            flex: 1,
            backgroundColor: '#d8d8d8',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            overflow: 'auto'
          }
        },
          window.React.createElement('div', {
            id: 'pdf-canvas',
            onDragOver: handleDragOver,
            onDragLeave: handleDragLeave,
            onDrop: handleDrop,
            style: {
              width: canvasConfig.width + 'px',
              height: canvasConfig.height + 'px',
              backgroundColor: 'white',
              boxShadow: '0 4px 12px rgba(0,0,0,0.2)',
              border: '1px solid #999',
              position: 'relative',
              cursor: 'default'
            }
          },
            window.React.createElement('div', {
              style: {
                position: 'absolute',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                textAlign: 'center',
                color: '#bbb',
                pointerEvents: 'none',
                fontSize: '12px'
              }
            },
              window.React.createElement('div', { style: { fontSize: '48px', marginBottom: '12px' } }, ''),
              window.React.createElement('div', { style: { fontWeight: 500 } }, canvasConfig.format),
              window.React.createElement('div', { style: { marginTop: '4px', fontSize: '11px' } }, canvasConfig.width + 'x' + canvasConfig.height + 'px @ ' + canvasConfig.dpi + ' DPI'),
              window.React.createElement('div', { style: { marginTop: '12px', fontSize: '11px', color: '#ddd' } }, ' Glissez les éléments ici')
            )
          )
        );
      };

      // ========== PROPERTIES PANEL ==========
      const PropertiesPanel = function() {
        return window.React.createElement('div', {
          style: {
            width: '280px',
            backgroundColor: '#ffffff',
            borderLeft: '1px solid #e0e0e0',
            overflow: 'auto',
            display: 'flex',
            flexDirection: 'column',
            fontSize: '12px'
          }
        },
          window.React.createElement('div', { style: { padding: '12px', borderBottom: '1px solid #e0e0e0', fontWeight: 600, fontSize: '13px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
            window.React.createElement('span', null, ' Propriétés (' + canvasElements.length + ')'),
            window.React.createElement('button', { style: { padding: '4px 8px', border: '1px solid #dc3545', borderRadius: '3px', backgroundColor: '#dc3545', color: '#fff', cursor: 'pointer', fontSize: '11px' } }, ' Suppr.')
          ),
          window.React.createElement('div', { style: { flex: 1, overflow: 'auto', padding: '12px' } },
            canvasElements.length === 0 ? 
              window.React.createElement('div', { style: { padding: '12px', backgroundColor: '#f9f9f9', border: '1px solid #e0e0e0', borderRadius: '4px', textAlign: 'center', color: '#999' } },
                window.React.createElement('div', { style: { fontSize: '32px', marginBottom: '8px', opacity: 0.5 } }, ''),
                window.React.createElement('div', { style: { fontWeight: 500 } }, 'Sélectionnez un élément'),
                window.React.createElement('div', { style: { fontSize: '11px', color: '#ccc', marginTop: '4px' } }, 'pour modifier ses propriétés')
              )
            :
              window.React.createElement('div', null,
                window.React.createElement('div', { style: { marginBottom: '12px' } },
                  window.React.createElement('label', { style: { display: 'block', fontSize: '11px', fontWeight: 600, marginBottom: '4px', color: '#666' } }, 'Éléments: ' + canvasElements.length),
                  canvasElements.map(function(el, idx) {
                    return window.React.createElement('div', {
                      key: idx,
                      onClick: function() {
                        selectedElementId = el.id;
                        const elem = document.getElementById(el.id);
                        if (elem) {
                          document.querySelectorAll('[id^="element_"]').forEach(function(e) {
                            e.style.borderColor = '#d0d0d0';
                          });
                          elem.style.borderColor = '#dc3545';
                        }
                      },
                      style: {
                        padding: '8px',
                        marginBottom: '6px',
                        backgroundColor: selectedElementId === el.id ? '#e3f2fd' : '#f5f5f5',
                        border: '1px solid ' + (selectedElementId === el.id ? '#007bff' : '#e0e0e0'),
                        borderRadius: '3px',
                        cursor: 'pointer',
                        fontSize: '11px'
                      }
                    },
                      el.text
                    );
                  })
                )
              )
          )
        );
      };

      // ========== MAIN LAYOUT ==========
      const EditorApp = window.React.createElement('div', {
        style: {
          display: 'flex',
          flexDirection: 'column',
          height: '100vh',
          backgroundColor: '#ffffff'
        }
      },
        window.React.createElement(Header, null),
        window.React.createElement(ToolbarHeader, null),
        window.React.createElement('div', {
          style: {
            display: 'flex',
            flex: 1,
            overflow: 'hidden',
            gap: '0px',
            backgroundColor: '#fff'
          }
        },
          window.React.createElement(ElementLibrary, null),
          window.React.createElement(Canvas, null),
          window.React.createElement(PropertiesPanel, null)
        )
      );

      // Rendu
      try {
        if (typeof window.ReactDOM.render === 'function') {
          window.ReactDOM.render(EditorApp, container);
          console.log('[PDF Builder] Editor with Drag & Drop rendered (React 16-17)');
        } else if (typeof window.ReactDOM.createRoot === 'function') {
          const root = window.ReactDOM.createRoot(container);
          root.render(EditorApp);
          console.log('[PDF Builder] Editor with Drag & Drop rendered (React 18+)');
        }
        return true;
      } catch (error) {
        console.error('[PDF Builder] Error rendering editor:', error);
        return false;
      }
    },

    init: function(rootElement, config) {
      console.log('[PDF Builder] React Wrapper init called');
      return this.initPDFBuilderReact(config);
    },

    _isLoaded: true
  };

  window.initPDFBuilderReact = function(config) {
    return window.pdfBuilderReact.initPDFBuilderReact(config);
  };

  console.log('[PDF Builder] React Wrapper loaded with Drag & Drop');
})();