/**
 * PDF Builder React Wrapper - V1 COMPLETE REPLICA WITH REAL HEADER & TOOLBAR
 */

(function() {
  'use strict';

  console.log('[PDF Builder] React Wrapper initializing - V1 Complete');

  if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') {
    console.error('[PDF Builder] React or ReactDOM not available');
    return;
  }

  window.pdfBuilderReact = {
    initPDFBuilderReact: function(config) {
      console.log('[PDF Builder] initPDFBuilderReact called');
      
      const container = document.getElementById('pdf-builder-react-root');
      if (!container) {
        console.error('[PDF Builder] Container not found');
        return false;
      }

      const canvasConfig = {
        format: 'A4',
        width: 794,
        height: 1123,
        dpi: 96,
        orientation: 'portrait',
        templateName: 'Nouveau Template',
        ...config
      };

      // State management
      let draggedElement = null;
      let canvasElements = [];
      let selectedElementId = null;
      let showPredefinedTemplates = false;

      // ========== REAL HEADER FROM V1 ==========
      const Header = function() {
        return window.React.createElement('div', {
          style: {
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '12px',
            paddingLeft: '12px',
            paddingRight: '12px',
            backgroundColor: '#ffffff',
            borderBottom: '2px solid #e0e0e0',
            borderRadius: '0px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1)',
            gap: '16px',
            zIndex: 1000,
            boxSizing: 'border-box'
          }
        },
          // Left Section - Title and Status
          window.React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', minWidth: 0, flex: 1 } },
            window.React.createElement('div', { style: { display: 'flex', alignItems: 'baseline', gap: '12px', minWidth: 0 } },
              window.React.createElement('h2', { style: { margin: 0, fontSize: '20px', fontWeight: '600', color: '#1a1a1a', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, canvasConfig.templateName),
              window.React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', flexShrink: 0 } },
                window.React.createElement('span', { style: { fontSize: '12px', padding: '4px 10px', backgroundColor: '#d1ecf1', color: '#0c5460', borderRadius: '4px', fontWeight: '500', border: '1px solid #bee5eb' } }, 'Nouveau')
              )
            )
          ),

          // Right Section - Action Buttons
          window.React.createElement('div', { style: { display: 'flex', gap: '10px', flexShrink: 0, alignItems: 'center' } },
            window.React.createElement('button', { 
              onClick: function() { console.log('[PDF Builder] New template'); },
              style: { padding: '10px 16px', border: '1px solid #ddd', borderRadius: '6px', backgroundColor: '#fff', color: '#333', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' } 
            }, ' Nouveau'),

            window.React.createElement('button', { 
              onClick: function() { console.log('[PDF Builder] Preview'); },
              style: { padding: '10px 16px', border: '1px solid #ddd', borderRadius: '6px', backgroundColor: '#fff', color: '#333', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' } 
            }, ' Aperçu'),

            window.React.createElement('div', { style: { width: '1px', height: '24px', backgroundColor: '#e0e0e0' } }),

            window.React.createElement('button', { 
              onClick: function() { console.log('[PDF Builder] JSON'); },
              style: { padding: '10px 16px', border: '1px solid #ddd', borderRadius: '6px', backgroundColor: '#fff', color: '#333', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' } 
            }, ' JSON'),

            window.React.createElement('button', { 
              onClick: function() { console.log('[PDF Builder] Settings'); },
              style: { padding: '10px 16px', border: '1px solid #ddd', borderRadius: '6px', backgroundColor: '#fff', color: '#333', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' } 
            }, ' Paramètres'),

            window.React.createElement('button', { 
              onClick: function() { console.log('[PDF Builder] Save'); },
              style: { padding: '10px 16px', borderRadius: '6px', backgroundColor: '#4CAF50', color: '#fff', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' } 
            }, ' Enregistrer')
          )
        );
      };

      // ========== REAL TOOLBAR FROM V1 ==========
      const Toolbar = function() {
        const tools = [
          { mode: 'select', label: 'Sélection', icon: '' },
          { mode: 'rectangle', label: 'Rectangle', icon: '' },
          { mode: 'circle', label: 'Cercle', icon: '' },
          { mode: 'text', label: 'Texte', icon: 'T' },
          { mode: 'line', label: 'Ligne', icon: '' },
          { mode: 'image', label: 'Image', icon: '' }
        ];

        return window.React.createElement('div', {
          style: {
            display: 'flex',
            gap: '16px',
            alignItems: 'flex-start',
            padding: '16px',
            backgroundColor: '#ffffff',
            border: '1px solid #e1e5e9',
            borderRadius: '8px',
            boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)',
            maxHeight: '140px',
            overflowY: 'auto'
          }
        },
          // Tools section
          window.React.createElement('section', { style: { display: 'flex', flexDirection: 'column', gap: '8px', minWidth: '220px', flex: 'none' } },
            window.React.createElement('div', { style: { fontSize: '13px', fontWeight: '600', color: '#374151', textTransform: 'uppercase', letterSpacing: '0.5px', borderLeft: '3px solid #3b82f6', paddingLeft: '8px' } }, 'Outils'),
            window.React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '6px', maxHeight: '80px', alignContent: 'flex-start' } },
              tools.map(function(tool, idx) {
                return window.React.createElement('button', {
                  key: idx,
                  onClick: function() { console.log('[PDF Builder] Tool selected:', tool.mode); },
                  style: {
                    padding: '8px 12px',
                    border: '1px solid #d1d5db',
                    borderRadius: '6px',
                    backgroundColor: '#ffffff',
                    color: '#374151',
                    cursor: 'pointer',
                    fontSize: '13px',
                    fontWeight: '500',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    transition: 'all 0.2s ease',
                    minWidth: '90px',
                    justifyContent: 'center'
                  }
                },
                  window.React.createElement('span', { style: { fontSize: '14px' } }, tool.icon),
                  window.React.createElement('span', null, tool.label)
                );
              })
            )
          ),

          // Actions section
          window.React.createElement('section', { style: { display: 'flex', flexDirection: 'column', gap: '8px', flex: 1 } },
            window.React.createElement('div', { style: { fontSize: '13px', fontWeight: '600', color: '#374151', textTransform: 'uppercase', letterSpacing: '0.5px', borderLeft: '3px solid #10b981', paddingLeft: '8px' } }, 'Actions'),
            window.React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '6px', maxHeight: '80px', alignContent: 'flex-start' } },
              window.React.createElement('button', { style: { padding: '8px 12px', border: '1px solid #d1d5db', borderRadius: '6px', backgroundColor: '#ffffff', color: '#374151', cursor: 'pointer', fontSize: '13px', fontWeight: '500', minWidth: '90px' } }, ' Annuler'),
              window.React.createElement('button', { style: { padding: '8px 12px', border: '1px solid #d1d5db', borderRadius: '6px', backgroundColor: '#ffffff', color: '#374151', cursor: 'pointer', fontSize: '13px', fontWeight: '500', minWidth: '90px' } }, ' Rétablir'),
              window.React.createElement('button', { style: { padding: '8px 12px', border: '1px solid #d1d5db', borderRadius: '6px', backgroundColor: '#ffffff', color: '#374151', cursor: 'pointer', fontSize: '13px', fontWeight: '500', minWidth: '90px' } }, ' Grille'),
              window.React.createElement('button', { style: { padding: '8px 12px', border: '1px solid #d1d5db', borderRadius: '6px', backgroundColor: '#ffffff', color: '#374151', cursor: 'pointer', fontSize: '13px', fontWeight: '500', minWidth: '90px' } }, ' Repères')
            )
          ),

          // Canvas Info section
          window.React.createElement('section', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
            window.React.createElement('div', { style: { fontSize: '13px', fontWeight: '600', color: '#374151', textTransform: 'uppercase', letterSpacing: '0.5px', borderLeft: '3px solid #8b5cf6', paddingLeft: '8px' } }, 'Canvas'),
            window.React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px', fontSize: '12px', color: '#666' } },
              window.React.createElement('div', null, 'Format: ' + canvasConfig.format),
              window.React.createElement('div', null, 'Taille: ' + canvasConfig.width + 'x' + canvasConfig.height + 'px'),
              window.React.createElement('div', null, 'DPI: ' + canvasConfig.dpi),
              window.React.createElement('div', null, 'Éléments: ' + canvasElements.length)
            )
          )
        );
      };

      // ========== ELEMENT LIBRARY ==========
      const ElementLibrary = function() {
        const elements = [
          { icon: '', label: 'Texte Dynamique', type: 'dynamic_text' },
          { icon: '', label: 'Tableau Produits', type: 'product_table' },
          { icon: '', label: 'Fiche Client', type: 'customer_info' },
          { icon: '[D]', label: 'Infos Entreprise', type: 'company_info' },
          { icon: '', label: 'Logo Entreprise', type: 'company_logo' },
          { icon: '', label: 'Numéro Commande', type: 'order_number' },
          { icon: '', label: 'Type Document', type: 'document_type' },
          { icon: 'T', label: 'Texte Simple', type: 'text' },
          { icon: '', label: 'Rectangle', type: 'rectangle' },
          { icon: '', label: 'Cercle', type: 'circle' },
          { icon: '', label: 'Ligne', type: 'line' },
          { icon: '', label: 'Image', type: 'image' }
        ];

        return window.React.createElement('div', {
          style: {
            width: '220px',
            backgroundColor: '#ffffff',
            borderRight: '1px solid #e0e0e0',
            overflow: 'auto',
            display: 'flex',
            flexDirection: 'column'
          }
        },
          window.React.createElement('div', { style: { padding: '12px', borderBottom: '1px solid #e0e0e0', fontWeight: '600', fontSize: '13px' } }, ' Éléments'),
          window.React.createElement('div', { style: { flex: 1, overflow: 'auto', padding: '8px' } },
            elements.map(function(el, idx) {
              return window.React.createElement('div', {
                key: idx,
                draggable: true,
                onDragStart: function(e) {
                  draggedElement = el;
                  e.dataTransfer.effectAllowed = 'copy';
                  e.dataTransfer.setData('text/plain', JSON.stringify(el));
                  console.log('[PDF Builder] Drag started:', el.type);
                },
                onDragEnd: function() {
                  draggedElement = null;
                },
                style: {
                  padding: '10px',
                  marginBottom: '6px',
                  backgroundColor: '#f8f9fa',
                  border: '1px solid #e0e0e0',
                  borderRadius: '4px',
                  cursor: 'move',
                  fontSize: '12px',
                  transition: 'all 0.2s',
                  userSelect: 'none'
                }
              },
                window.React.createElement('div', { style: { fontSize: '16px', marginBottom: '4px' } }, el.icon),
                window.React.createElement('div', { style: { fontWeight: 500, color: '#333' } }, el.label),
                window.React.createElement('div', { style: { fontSize: '10px', color: '#999', marginTop: '2px' } }, 'Glisser sur canvas')
              );
            })
          )
        );
      };

      // ========== CANVAS WITH DRAG & DROP ==========
      const Canvas = function() {
        const handleDragOver = function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          const canvas = e.currentTarget;
          canvas.style.backgroundColor = '#d0d0d0';
        };

        const handleDragLeave = function(e) {
          if (e.currentTarget === e.target) {
            e.currentTarget.style.backgroundColor = '#d8d8d8';
          }
        };

        const handleDrop = function(e) {
          e.preventDefault();
          e.currentTarget.style.backgroundColor = '#d8d8d8';

          if (!draggedElement) return;

          const canvas = document.getElementById('pdf-canvas');
          if (!canvas) return;

          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          const newElement = {
            id: 'element_' + Date.now(),
            type: draggedElement.type,
            x: Math.max(0, x - 50),
            y: Math.max(0, y - 25),
            width: 100,
            height: 50,
            text: draggedElement.label
          };

          canvasElements.push(newElement);

          const elementDiv = document.createElement('div');
          elementDiv.id = newElement.id;
          elementDiv.draggable = true;
          elementDiv.style.position = 'absolute';
          elementDiv.style.left = newElement.x + 'px';
          elementDiv.style.top = newElement.y + 'px';
          elementDiv.style.width = newElement.width + 'px';
          elementDiv.style.height = newElement.height + 'px';
          elementDiv.style.backgroundColor = '#fff';
          elementDiv.style.border = '2px solid #007bff';
          elementDiv.style.borderRadius = '4px';
          elementDiv.style.cursor = 'move';
          elementDiv.style.padding = '8px';
          elementDiv.style.boxSizing = 'border-box';
          elementDiv.style.fontSize = '12px';
          elementDiv.style.textAlign = 'center';
          elementDiv.style.display = 'flex';
          elementDiv.style.alignItems = 'center';
          elementDiv.style.justifyContent = 'center';
          elementDiv.textContent = draggedElement.icon + ' ' + draggedElement.label;

          elementDiv.onclick = function(e) {
            e.stopPropagation();
            selectedElementId = newElement.id;
            document.querySelectorAll('[id^="element_"]').forEach(function(el) {
              el.style.borderColor = '#d0d0d0';
            });
            elementDiv.style.borderColor = '#dc3545';
          };

          elementDiv.ondragstart = function(e) {
            const startX = e.clientX;
            const startY = e.clientY;
            const startLeft = parseInt(elementDiv.style.left) || 0;
            const startTop = parseInt(elementDiv.style.top) || 0;

            const handleMouseMove = function(moveEvent) {
              const deltaX = moveEvent.clientX - startX;
              const deltaY = moveEvent.clientY - startY;
              elementDiv.style.left = (startLeft + deltaX) + 'px';
              elementDiv.style.top = (startTop + deltaY) + 'px';
            };

            const handleMouseUp = function() {
              document.removeEventListener('mousemove', handleMouseMove);
              document.removeEventListener('mouseup', handleMouseUp);
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
          };

          canvas.appendChild(elementDiv);
        };

        return window.React.createElement('div', {
          style: {
            flex: 1,
            backgroundColor: '#d8d8d8',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            overflow: 'auto'
          }
        },
          window.React.createElement('div', {
            id: 'pdf-canvas',
            onDragOver: handleDragOver,
            onDragLeave: handleDragLeave,
            onDrop: handleDrop,
            style: {
              width: canvasConfig.width + 'px',
              height: canvasConfig.height + 'px',
              maxHeight: 'calc(100vh - 280px)',
              backgroundColor: 'white',
              boxShadow: '0 4px 12px rgba(0,0,0,0.2)',
              border: '1px solid #999',
              position: 'relative',
              cursor: 'default',
              flexShrink: 0
            }
          },
            window.React.createElement('div', {
              style: {
                position: 'absolute',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                textAlign: 'center',
                color: '#bbb',
                pointerEvents: 'none',
                fontSize: '12px'
              }
            },
              window.React.createElement('div', { style: { fontSize: '48px', marginBottom: '12px' } }, ''),
              window.React.createElement('div', { style: { fontWeight: 500 } }, canvasConfig.format),
              window.React.createElement('div', { style: { marginTop: '4px', fontSize: '11px' } }, canvasConfig.width + 'x' + canvasConfig.height + 'px @ ' + canvasConfig.dpi + ' DPI'),
              window.React.createElement('div', { style: { marginTop: '12px', fontSize: '11px', color: '#ddd' } }, ' Glissez les éléments ici')
            )
          )
        );
      };

      // ========== PROPERTIES PANEL ==========
      const PropertiesPanel = function() {
        return window.React.createElement('div', {
          style: {
            width: '280px',
            backgroundColor: '#ffffff',
            borderLeft: '1px solid #e0e0e0',
            overflow: 'auto',
            display: 'flex',
            flexDirection: 'column',
            fontSize: '12px'
          }
        },
          window.React.createElement('div', { style: { padding: '12px', borderBottom: '1px solid #e0e0e0', fontWeight: '600', fontSize: '13px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
            window.React.createElement('span', null, ' Propriétés (' + canvasElements.length + ')'),
            window.React.createElement('button', { style: { padding: '4px 8px', border: '1px solid #dc3545', borderRadius: '3px', backgroundColor: '#dc3545', color: '#fff', cursor: 'pointer', fontSize: '11px' } }, ' Suppr.')
          ),
          window.React.createElement('div', { style: { flex: 1, overflow: 'auto', padding: '12px' } },
            canvasElements.length === 0 ? 
              window.React.createElement('div', { style: { padding: '12px', backgroundColor: '#f9f9f9', border: '1px solid #e0e0e0', borderRadius: '4px', textAlign: 'center', color: '#999' } },
                window.React.createElement('div', { style: { fontSize: '32px', marginBottom: '8px', opacity: 0.5 } }, ''),
                window.React.createElement('div', { style: { fontWeight: 500 } }, 'Sélectionnez un élément'),
                window.React.createElement('div', { style: { fontSize: '11px', color: '#ccc', marginTop: '4px' } }, 'pour modifier ses propriétés')
              )
            :
              window.React.createElement('div', null,
                window.React.createElement('div', { style: { marginBottom: '12px' } },
                  canvasElements.map(function(el, idx) {
                    return window.React.createElement('div', {
                      key: idx,
                      onClick: function() {
                        selectedElementId = el.id;
                        const elem = document.getElementById(el.id);
                        if (elem) {
                          document.querySelectorAll('[id^="element_"]').forEach(function(e) {
                            e.style.borderColor = '#d0d0d0';
                          });
                          elem.style.borderColor = '#dc3545';
                        }
                      },
                      style: {
                        padding: '8px',
                        marginBottom: '6px',
                        backgroundColor: selectedElementId === el.id ? '#e3f2fd' : '#f5f5f5',
                        border: '1px solid ' + (selectedElementId === el.id ? '#007bff' : '#e0e0e0'),
                        borderRadius: '3px',
                        cursor: 'pointer',
                        fontSize: '11px'
                      }
                    },
                      el.text
                    );
                  })
                )
              )
          )
        );
      };

      // ========== MAIN LAYOUT ==========
      const EditorApp = window.React.createElement('div', {
        style: {
          display: 'flex',
          flexDirection: 'column',
          height: '100vh',
          backgroundColor: '#ffffff'
        }
      },
        window.React.createElement(Header, null),
        window.React.createElement(Toolbar, null),
        window.React.createElement('div', {
          style: {
            display: 'flex',
            flex: 1,
            overflow: 'hidden',
            gap: '0px',
            backgroundColor: '#fff'
          }
        },
          window.React.createElement(ElementLibrary, null),
          window.React.createElement(Canvas, null),
          window.React.createElement(PropertiesPanel, null)
        )
      );

      // Rendu
      try {
        if (typeof window.ReactDOM.render === 'function') {
          window.ReactDOM.render(EditorApp, container);
          console.log('[PDF Builder] Complete V1 editor rendered (React 16-17)');
        } else if (typeof window.ReactDOM.createRoot === 'function') {
          const root = window.ReactDOM.createRoot(container);
          root.render(EditorApp);
          console.log('[PDF Builder] Complete V1 editor rendered (React 18+)');
        }
        return true;
      } catch (error) {
        console.error('[PDF Builder] Error rendering editor:', error);
        return false;
      }
    },

    init: function(rootElement, config) {
      console.log('[PDF Builder] React Wrapper init called');
      return this.initPDFBuilderReact(config);
    },

    _isLoaded: true
  };

  window.initPDFBuilderReact = function(config) {
    return window.pdfBuilderReact.initPDFBuilderReact(config);
  };

  console.log('[PDF Builder] React Wrapper loaded - Complete V1 Replica');
})();