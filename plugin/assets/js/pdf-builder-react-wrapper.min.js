/**
 * PDF Builder React Wrapper - V1 with Working Drag, Drop, Resize
 */
(function() {
  if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') return;

  window.pdfBuilderReact = {
    initPDFBuilderReact: function(config) {
      const container = document.getElementById('pdf-builder-react-root');
      if (!container) return false;

      const canvasConfig = { format: 'A4', width: 794, height: 1123, dpi: 96, templateName: 'Nouveau Template', ...config };
      let draggedElement = null;
      let canvasElements = [];
      let selectedElementId = null;
      let draggingElementId = null;
      let resizingElementId = null;
      let renderKey = 0;

      const triggerRender = () => {
        renderKey++;
        renderApp();
      };

      const Header = function() {
        return window.React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 16px', backgroundColor: '#fff', borderBottom: '1px solid #ddd', boxShadow: '0 1px 2px rgba(0,0,0,0.05)', zIndex: 1000 } },
          window.React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', flex: 1 } },
            window.React.createElement('h2', { style: { margin: 0, fontSize: '18px', fontWeight: '600', color: '#1a1a1a' } }, canvasConfig.templateName),
            window.React.createElement('span', { style: { fontSize: '11px', padding: '2px 8px', backgroundColor: '#d1ecf1', color: '#0c5460', borderRadius: '3px', border: '1px solid #bee5eb' } }, 'Nouveau')
          ),
          window.React.createElement('div', { style: { display: 'flex', gap: '8px' } },
            ['Nouveau', 'Aperçu', 'JSON', 'Paramètres'].map(btn => window.React.createElement('button', { key: btn, style: { padding: '6px 12px', border: '1px solid #ccc', borderRadius: '4px', backgroundColor: '#fff', cursor: 'pointer', fontSize: '12px' } }, btn)),
            window.React.createElement('button', { style: { padding: '6px 12px', borderRadius: '4px', backgroundColor: '#4CAF50', color: '#fff', border: 'none', cursor: 'pointer', fontSize: '12px' } }, 'Enregistrer')
          )
        );
      };

      const Toolbar = function() {
        return window.React.createElement('div', { style: { display: 'flex', gap: '16px', padding: '12px 16px', backgroundColor: '#fff', border: '1px solid #e1e5e9', overflowX: 'auto' } },
          window.React.createElement('section', { style: { display: 'flex', flexDirection: 'column', gap: '6px' } },
            window.React.createElement('div', { style: { fontSize: '10px', fontWeight: '700', color: '#666', borderLeft: '3px solid #3b82f6', paddingLeft: '6px' } }, 'OUTILS'),
            window.React.createElement('div', { style: { display: 'flex', gap: '4px' } },
              [{ label: 'Sélection', icon: '' }, { label: 'Rectangle', icon: '' }, { label: 'Cercle', icon: '' }, { label: 'Texte', icon: 'T' }, { label: 'Ligne', icon: '' }, { label: 'Image', icon: '' }].map(t => 
                window.React.createElement('button', { key: t.label, style: { padding: '6px 10px', border: '1px solid #ccc', borderRadius: '3px', fontSize: '11px', cursor: 'pointer' } }, t.icon + ' ' + t.label.substring(0, 4))
              )
            )
          ),
          window.React.createElement('section', { style: { display: 'flex', flexDirection: 'column', gap: '6px' } },
            window.React.createElement('div', { style: { fontSize: '10px', fontWeight: '700', color: '#666', borderLeft: '3px solid #10b981', paddingLeft: '6px' } }, 'ACTIONS'),
            window.React.createElement('div', { style: { display: 'flex', gap: '4px' } },
              [' Undo', ' Redo', ' Grid', ' Guide'].map(a => window.React.createElement('button', { key: a, style: { padding: '6px 10px', border: '1px solid #ccc', borderRadius: '3px', fontSize: '11px', cursor: 'pointer' } }, a))
            )
          ),
          window.React.createElement('section', { style: { display: 'flex', flexDirection: 'column', gap: '6px', marginLeft: 'auto' } },
            window.React.createElement('div', { style: { fontSize: '10px', fontWeight: '700', color: '#666', borderLeft: '3px solid #8b5cf6', paddingLeft: '6px' } }, 'CANVAS'),
            window.React.createElement('div', { style: { fontSize: '11px', color: '#555' } }, canvasConfig.format + ' | ' + canvasElements.length + ' elem')
          )
        );
      };

      const ElementLibrary = function() {
        const elements = [{ icon: '', label: 'Texte Dynamique', type: 'dynamic_text' }, { icon: '', label: 'Tableau', type: 'product_table' }, { icon: '', label: 'Client', type: 'customer_info' }, { icon: '[D]', label: 'Entreprise', type: 'company_info' }, { icon: '', label: 'Logo', type: 'company_logo' }, { icon: '', label: 'Commande', type: 'order_number' }, { icon: '', label: 'Document', type: 'document_type' }, { icon: 'T', label: 'Texte', type: 'text' }, { icon: '', label: 'Rect', type: 'rectangle' }, { icon: '', label: 'Cercle', type: 'circle' }, { icon: '', label: 'Ligne', type: 'line' }, { icon: '', label: 'Image', type: 'image' }];
        return window.React.createElement('div', { style: { width: '200px', backgroundColor: '#fff', borderRight: '1px solid #ddd', overflow: 'auto', display: 'flex', flexDirection: 'column' } },
          window.React.createElement('div', { style: { padding: '10px', borderBottom: '1px solid #ddd', fontWeight: '600', fontSize: '12px', backgroundColor: '#f9f9f9' } }, ' Éléments'),
          window.React.createElement('div', { style: { flex: 1, overflow: 'auto', padding: '6px' } }, elements.map(el => window.React.createElement('div', { key: el.type, draggable: true, onDragStart: (e) => { draggedElement = el; e.dataTransfer.effectAllowed = 'copy'; }, onDragEnd: () => { draggedElement = null; }, style: { padding: '8px', marginBottom: '4px', backgroundColor: '#f8f9fa', border: '1px solid #ddd', borderRadius: '3px', cursor: 'move', fontSize: '10px', userSelect: 'none' } }, el.icon + ' ' + el.label)))
        );
      };

      const Canvas = function() {
        return window.React.createElement('div', { style: { flex: 1, backgroundColor: '#d8d8d8', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', overflow: 'auto' } },
          window.React.createElement('div', { 
            key: renderKey,
            id: 'pdf-canvas',
            onDragOver: (e) => { e.preventDefault(); e.currentTarget.style.backgroundColor = '#e0e0e0'; },
            onDragLeave: (e) => { if(e.currentTarget === e.target) e.currentTarget.style.backgroundColor = '#d8d8d8'; },
            onDrop: (e) => {
              e.preventDefault();
              e.currentTarget.style.backgroundColor = '#d8d8d8';
              if (!draggedElement) return;
              const rect = e.currentTarget.getBoundingClientRect();
              const newElem = { id: 'elem_' + Date.now(), type: draggedElement.type, label: draggedElement.label, icon: draggedElement.icon, x: Math.max(0, e.clientX - rect.left - 50), y: Math.max(0, e.clientY - rect.top - 25), w: 100, h: 50 };
              canvasElements.push(newElem);
              selectedElementId = newElem.id;
              triggerRender();
            },
            style: { width: canvasConfig.width + 'px', height: canvasConfig.height + 'px', backgroundColor: '#fff', boxShadow: '0 4px 12px rgba(0,0,0,0.2)', border: '1px solid #999', position: 'relative', flexShrink: 0, cursor: 'default' }
          },
            canvasElements.length === 0 ?
              window.React.createElement('div', { style: { position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', textAlign: 'center', color: '#bbb', pointerEvents: 'none' } },
                window.React.createElement('div', { style: { fontSize: '40px', marginBottom: '10px' } }, ''),
                window.React.createElement('div', { style: { fontSize: '12px' } }, canvasConfig.format)
              )
              : null,
            canvasElements.map((elem, idx) => {
              const isSelected = elem.id === selectedElementId;
              return window.React.createElement('div', { key: elem.id, 
                onMouseDown: (e) => { if(e.button === 0) { e.preventDefault(); selectedElementId = elem.id; draggingElementId = elem.id; const startX = e.clientX; const startY = e.clientY; const startLeft = elem.x; const startTop = elem.y; const move = (me) => { elem.x = Math.max(0, startLeft + (me.clientX - startX)); elem.y = Math.max(0, startTop + (me.clientY - startY)); triggerRender(); }; const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); draggingElementId = null; }; document.addEventListener('mousemove', move); document.addEventListener('mouseup', up); } },
                style: { position: 'absolute', left: elem.x + 'px', top: elem.y + 'px', width: elem.w + 'px', height: elem.h + 'px', backgroundColor: '#e8f4f8', border: (isSelected ? '2px solid #dc3545' : '2px solid #3b82f6'), borderRadius: '3px', padding: '4px', boxSizing: 'border-box', cursor: draggingElementId === elem.id ? 'grabbing' : 'grab', display: 'flex', alignItems: 'center', justifyContent: 'center', textAlign: 'center', color: '#333', userSelect: 'none', fontSize: '9px', transition: draggingElementId === elem.id ? 'none' : 'border 0.1s' }
              },
                window.React.createElement('div', null,
                  window.React.createElement('div', { style: { fontSize: '12px', marginBottom: '2px' } }, elem.icon),
                  window.React.createElement('div', { style: { fontSize: '8px', color: '#666' } }, elem.label.substring(0, 10))
                ),
                isSelected && window.React.createElement('div', null,
                  ['top-left', 'top-right', 'bottom-left', 'bottom-right'].map(corner =>
                    window.React.createElement('div', { key: corner,
                      onMouseDown: (e) => { e.stopPropagation(); e.preventDefault(); resizingElementId = elem.id; const startX = e.clientX; const startY = e.clientY; const startW = elem.w; const startH = elem.h; const startLeft = elem.x; const startTop = elem.y; const move = (me) => {
                        const deltaX = me.clientX - startX; const deltaY = me.clientY - startY;
                        if (corner.includes('right')) elem.w = Math.max(30, startW + deltaX);
                        if (corner.includes('bottom')) elem.h = Math.max(30, startH + deltaY);
                        if (corner.includes('left')) { elem.w = Math.max(30, startW - deltaX); elem.x = Math.min(startLeft + startW - 30, startLeft + deltaX); }
                        if (corner.includes('top')) { elem.h = Math.max(30, startH - deltaY); elem.y = Math.min(startTop + startH - 30, startTop + deltaY); }
                        triggerRender();
                      };
                      const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); resizingElementId = null; triggerRender(); };
                      document.addEventListener('mousemove', move); document.addEventListener('mouseup', up);
                    },
                      style: { position: 'absolute', width: '8px', height: '8px', backgroundColor: '#dc3545', ...(corner === 'top-left' ? { top: '-4px', left: '-4px', cursor: 'nwse-resize' } : corner === 'top-right' ? { top: '-4px', right: '-4px', cursor: 'nesw-resize' } : corner === 'bottom-left' ? { bottom: '-4px', left: '-4px', cursor: 'nesw-resize' } : { bottom: '-4px', right: '-4px', cursor: 'nwse-resize' }) }
                    })
                  )
                )
              );
            })
          )
        );
      };

      const PropertiesPanel = function() {
        const sel = canvasElements.find(e => e.id === selectedElementId);
        return window.React.createElement('div', { style: { width: '250px', backgroundColor: '#fff', borderLeft: '1px solid #ddd', overflow: 'auto', display: 'flex', flexDirection: 'column' } },
          window.React.createElement('div', { style: { padding: '10px', borderBottom: '1px solid #ddd', fontWeight: '600', fontSize: '12px', backgroundColor: '#f9f9f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
            window.React.createElement('span', null, ' Propriétés'),
            sel && window.React.createElement('button', { onClick: () => { canvasElements = canvasElements.filter(e => e.id !== selectedElementId); selectedElementId = null; triggerRender(); }, style: { padding: '4px 8px', border: '1px solid #dc3545', borderRadius: '3px', backgroundColor: '#dc3545', color: '#fff', cursor: 'pointer', fontSize: '10px', fontWeight: '500' } }, '')
          ),
          window.React.createElement('div', { style: { flex: 1, padding: '10px', overflow: 'auto' } },
            sel ? window.React.createElement('div', null,
              window.React.createElement('div', { style: { fontSize: '11px', fontWeight: '600', marginBottom: '8px', padding: '8px', backgroundColor: '#f0f0f0', borderRadius: '3px' } }, sel.type.toUpperCase()),
              window.React.createElement('div', { style: { display: 'grid', gap: '8px' } },
                [{ label: 'X', key: 'x' }, { label: 'Y', key: 'y' }, { label: 'W', key: 'w' }, { label: 'H', key: 'h' }].map(p =>
                  window.React.createElement('div', { key: p.key, style: { display: 'grid', gridTemplateColumns: '30px 1fr', gap: '4px', alignItems: 'center' } },
                    window.React.createElement('label', { style: { fontSize: '10px', fontWeight: '600', color: '#555' } }, p.label),
                    window.React.createElement('input', { type: 'number', value: Math.round(sel[p.key]), onChange: (e) => { sel[p.key] = parseFloat(e.target.value) || 0; triggerRender(); }, style: { padding: '4px', border: '1px solid #ccc', borderRadius: '3px', fontSize: '11px' } })
                  )
                )
              )
            ) : window.React.createElement('div', { style: { textAlign: 'center', color: '#999', paddingTop: '20px' } }, ' Sélectionnez')
          )
        );
      };

      const renderApp = function() {
        try {
          const App = window.React.createElement('div', { style: { display: 'flex', flexDirection: 'column', height: '100vh', backgroundColor: '#fff' }, key: renderKey },
            window.React.createElement(Header, null),
            window.React.createElement(Toolbar, null),
            window.React.createElement('div', { style: { display: 'flex', flex: 1, overflow: 'hidden' } },
              window.React.createElement(ElementLibrary, null),
              window.React.createElement(Canvas, null),
              window.React.createElement(PropertiesPanel, null)
            )
          );

          if (typeof window.ReactDOM.render === 'function') {
            window.ReactDOM.render(App, container);
          } else if (typeof window.ReactDOM.createRoot === 'function') {
            window.ReactDOM.createRoot(container).render(App);
          }
        } catch(e) { console.error('[PDF Builder] Render error:', e); }
      };

      renderApp();
      return true;
    },
    _isLoaded: true
  };
  window.initPDFBuilderReact = config => window.pdfBuilderReact.initPDFBuilderReact(config);
})();
