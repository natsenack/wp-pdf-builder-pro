"use strict";(Object("undefined"!=typeof window?window:global).webpackChunkwp_pdf_builder_pro_v2=Object("undefined"!=typeof window?window:global).webpackChunkwp_pdf_builder_pro_v2||[]).push([[835],{932(e,a,t){t.r(a),function(e){const a="DEBUG",t="INFO",o="WARN",n="ERROR";function l(a,t,o=null){(new Date).toISOString(),"undefined"!=typeof pdf_builder_canvas_settings&&pdf_builder_canvas_settings.ajax_url&&e.ajax({url:pdf_builder_canvas_settings.ajax_url,type:"POST",data:{action:"pdf_builder_log_client_event",level:a,message:t,data:JSON.stringify(o),nonce:pdf_builder_canvas_settings.nonce},async:!0,error:function(){}})}class s{constructor(){this.modals={},this.currentModal=null,this.isInitialized=!1,l(t,"CanvasModalManager initialized")}init(){this.isInitialized?l(o,"CanvasModalManager already initialized"):(l(t,"Initializing Canvas Modal System..."),this.registerModals(),this.bindEvents(),this.isInitialized=!0,l(t,"Canvas Modal System initialized successfully"))}registerModals(){["canvas-affichage-modal-overlay","canvas-navigation-modal-overlay","canvas-comportement-modal-overlay","canvas-systeme-modal-overlay"].forEach(e=>{const t=document.getElementById(e);if(t){const o=e.replace("canvas-","").replace("-modal-overlay","");this.modals[o]={id:e,element:t,category:o,applyButton:t.querySelector(".canvas-modal-apply"),cancelButton:t.querySelector(".canvas-modal-cancel"),closeButton:t.querySelector(".canvas-modal-close")},l(a,`Registered modal: ${o}`,{modalId:e,hasApplyButton:!!this.modals[o].applyButton})}else l(o,`Modal not found: ${e}`)})}bindEvents(){l(a,"Binding modal events..."),document.addEventListener("click",e=>{const a=e.target.closest(".canvas-configure-btn");a&&(e.preventDefault(),this.handleConfigureButtonClick(a))}),document.addEventListener("click",e=>{const a=e.target.closest(".canvas-modal-apply");a&&(e.preventDefault(),this.handleApplyButtonClick(a))}),document.addEventListener("click",e=>{const a=e.target.closest(".canvas-modal-cancel"),t=e.target.closest(".canvas-modal-close");(a||t)&&(e.preventDefault(),this.handleCloseButtonClick(a||t))}),document.addEventListener("click",e=>{e.target.classList.contains("canvas-modal-overlay")&&this.closeModal(e.target)}),l(a,"Modal events bound successfully")}handleConfigureButtonClick(e){const a=e.closest(".canvas-card");if(!a)return void l(n,"Configure button clicked but no parent card found");const o=a.getAttribute("data-category");o?(l(t,`Opening modal for category: ${o}`),this.openModal(o)):l(n,"Configure button clicked but no category found on card")}async handleApplyButtonClick(e){const a=e.closest(".canvas-modal-overlay");if(!a)return void l(n,"Apply button clicked but no parent modal found");const o=e.getAttribute("data-category");o?(l(t,`Applying settings for modal: ${o}`),await this.saveModalSettings(a,o)):l(n,"Apply button clicked but no category found")}handleCloseButtonClick(e){const t=e.closest(".canvas-modal-overlay");t&&(l(a,"Closing modal via button click"),this.closeModal(t))}openModal(e){const a=this.modals[e];a?(l(t,`Opening modal: ${e}`,{modalId:a.id}),this.closeAllModals(),a.element.style.display="flex",document.body.style.overflow="hidden",this.currentModal=a,this.syncModalValues(a),l(t,`Modal ${e} opened successfully`)):l(n,`Cannot open modal: unknown category ${e}`)}closeModal(e){if(!e)return;const t=this.getModalCategory(e);l(a,`Closing modal: ${t||"unknown"}`),e.style.display="none",document.body.style.overflow="",this.currentModal=null}closeAllModals(){Object.values(this.modals).forEach(e=>{e.element.style.display="none"}),document.body.style.overflow="",this.currentModal=null}syncModalValues(e){l(a,`Syncing values for modal: ${e.category}`)}async saveModalSettings(e,o){l(t,`Starting save process for modal: ${o}`);try{const n=this.collectModalData(e,o);l(a,`Collected form data for ${o}:`,{fieldCount:n.getAll?n.getAll("field_count")[0]:"unknown",action:n.get("action"),category:n.get("category")});const s=e.querySelector(".canvas-modal-apply");s&&(s.disabled=!0,s.textContent="⏳ Sauvegarde...");const i=await this.sendSaveRequest(n);if(l(t,`Save response received for ${o}:`,i),!i.success)throw new Error(i.data?.message||"Erreur inconnue lors de la sauvegarde");l(t,`Settings saved successfully for ${o}`),this.showNotification("Paramètres sauvegardés avec succès !","success"),this.closeModal(e),setTimeout(()=>{window.location.reload()},1e3)}catch(e){l(n,`Save failed for modal ${o}:`,e),this.showNotification(`Erreur lors de la sauvegarde: ${e.message}`,"error")}finally{const a=e.querySelector(".canvas-modal-apply");a&&(a.disabled=!1,a.textContent="✅ Appliquer")}}collectModalData(e,o){l(a,`Collecting data from modal: ${o}`);const n=new FormData;let s=0;return n.append("action","pdf_builder_save_canvas_modal"),n.append("category",o),n.append("nonce",pdf_builder_canvas_settings?.nonce||""),e.querySelectorAll("input, select, textarea").forEach(e=>{const t=e.name,o=e.type;if(!t||e.disabled)return;let i=null;if("checkbox"===o)i=e.checked?"1":"0";else if("radio"===o){if(!e.checked)return;i=e.value}else i=e.value;null!==i&&(n.append(t,i),s++,l(a,`Collected field: ${t} = ${i}`))}),n.append("field_count",s.toString()),l(t,`Collected ${s} fields from modal ${o}`),n}async sendSaveRequest(t){const o=pdf_builder_canvas_settings?.ajax_url||ajaxurl;return l(a,`Sending AJAX request to: ${o}`),new Promise((s,i)=>{e.ajax({url:o,type:"POST",data:t,processData:!1,contentType:!1,success:e=>{l(a,"AJAX request successful",e),s(e)},error:(e,a,t)=>{l(n,"AJAX request failed",{xhr:e,status:a,error:t}),i(new Error(`Erreur AJAX: ${t}`))}})})}showNotification(e,t){l(a,`Showing notification: ${t} - ${e}`),"undefined"!=typeof showSystemNotification?showSystemNotification(e,t):alert(e)}getModalCategory(e){for(const[a,t]of Object.entries(this.modals))if(t.element===e)return a;return null}}e(document).ready(function(){if(l(t,"Document ready, initializing Canvas Modal Manager..."),void 0===e)return;let a=[];if(["canvas-affichage-modal-overlay","canvas-navigation-modal-overlay","canvas-comportement-modal-overlay","canvas-systeme-modal-overlay"].forEach(e=>{document.getElementById(e)||a.push(e)}),a.length>0)return void l(n,"Missing modal elements:",a);const o=document.querySelectorAll(".canvas-configure-btn");if(0!==o.length){l(t,`Found ${o.length} configure buttons and all modals`);try{window.canvasModalManager=new s,window.canvasModalManager.init(),l(t,"Canvas Modal System ready")}catch(e){l(n,"Failed to initialize CanvasModalManager:",e)}}else l(n,"No configure buttons found!")})}(jQuery)}},e=>{var a=e(e.s=932),t=window;for(var o in a)t[o]=a[o];a.__esModule&&Object.defineProperty(t,"__esModule",{value:!0})}]);