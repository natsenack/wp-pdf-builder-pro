/*! For license information please see hooks-contexts-c664a2a3.js.LICENSE.txt */
"use strict";(this.webpackChunkwp_pdf_builder_pro=this.webpackChunkwp_pdf_builder_pro||[]).push([[463],{76:function(e,t,r){r.d(t,{g:function(){return l}});var n=r(594);function a(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",i=r.toStringTag||"@@toStringTag";function u(r,n,a,i){var u=n&&n.prototype instanceof l?n:l,s=Object.create(u.prototype);return o(s,"_invoke",function(r,n,a){var o,i,u,l=0,s=a||[],f=!1,p={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,r){return o=t,i=0,u=e,p.n=r,c}};function d(r,n){for(i=r,u=n,t=0;!f&&l&&!a&&t<s.length;t++){var a,o=s[t],d=p.p,v=o[2];r>3?(a=v===n)&&(u=o[(i=o[4])?5:(i=3,3)],o[4]=o[5]=e):o[0]<=d&&((a=r<2&&d<o[1])?(i=0,p.v=n,p.n=o[1]):d<v&&(a=r<3||o[0]>n||n>v)&&(o[4]=r,o[5]=n,p.n=v,i=0))}if(a||r>1)return c;throw f=!0,n}return function(a,s,v){if(l>1)throw TypeError("Generator is already running");for(f&&1===s&&d(s,v),i=s,u=v;(t=i<2?e:u)||!f;){o||(i?i<3?(i>1&&(p.n=-1),d(i,u)):p.n=u:p.v=u);try{if(l=2,o){if(i||(a="next"),t=o[a]){if(!(t=t.call(o,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=o.return)&&t.call(o),i<2&&(u=TypeError("The iterator does not provide a '"+a+"' method"),i=1);o=e}else if((t=(f=p.n<0)?u:r.call(n,p))!==c)break}catch(t){o=e,i=1,u=t}finally{l=1}}return{value:t,done:f}}}(r,a,i),!0),s}var c={};function l(){}function s(){}function f(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(o(t={},n,function(){return this}),t),d=f.prototype=l.prototype=Object.create(p);function v(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,o(e,i,"GeneratorFunction")),e.prototype=Object.create(d),e}return s.prototype=f,o(d,"constructor",f),o(f,"constructor",s),s.displayName="GeneratorFunction",o(f,i,"GeneratorFunction"),o(d),o(d,i,"Generator"),o(d,n,function(){return this}),o(d,"toString",function(){return"[object Generator]"}),(a=function(){return{w:u,m:v}})()}function o(e,t,r,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,t,r,n){function i(t,r){o(e,t,function(e){return this._invoke(t,r,e)})}t?a?a(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(i("next",0),i("throw",1),i("return",2))},o(e,t,r,n)}function i(e,t,r,n,a,o,i){try{var u=e[o](i),c=u.value}catch(e){return void r(e)}u.done?t(c):Promise.resolve(c).then(n,a)}function u(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o,i,u=[],c=!0,l=!1;try{if(o=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=o.call(r)).done)&&(u.push(n.value),u.length!==t);c=!0);}catch(e){l=!0,a=e}finally{try{if(!c&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(l)throw a}}return u}}(e,t)||function(e,t){if(e){if("string"==typeof e)return c(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?c(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function l(){var e=u((0,n.useState)(!1),2),t=e[0],r=e[1],o=u((0,n.useState)(!1),2),c=o[0],l=o[1],s=u((0,n.useState)(null),2),f=s[0],p=s[1],d=u((0,n.useState)(null),2),v=d[0],m=d[1],y=u((0,n.useState)("png"),2),h=y[0],b=y[1],g=(0,n.useCallback)(function(){r(!0),m(null),p(null)},[]),w=(0,n.useCallback)(function(){r(!1),l(!1),p(null),m(null)},[]),S=(0,n.useCallback)(function(){p(null),m(null)},[]),E=(0,n.useCallback)(function(){var e,t=(e=a().m(function e(t){var r,n,o,i,u,c,s=arguments;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=(r=s.length>1&&void 0!==s[1]?s[1]:{}).format||h,o=r.quality||150,l(!0),m(null),p(null),e.p=1,t.elements&&t.elements.length>0){e.n=2;break}throw new Error("Aucun contenu dans le template. Ajoutez des éléments avant de générer un aperçu.");case 2:if(void 0!==window.pdfPreviewAPI){e.n=3;break}throw new Error("API Preview non disponible. Vérifiez que les scripts sont chargés.");case 3:return e.n=4,window.pdfPreviewAPI.generateEditorPreview(t,{format:n,quality:o});case 4:if(!((i=e.v)&&i.success&&i.image_url)){e.n=5;break}"pdf"===n?(window.open(i.image_url,"_blank"),p(null)):p(i.image_url),e.n=6;break;case 5:throw new Error((null==i?void 0:i.error)||"Erreur lors de la génération de l'aperçu");case 6:e.n=8;break;case 7:e.p=7,c=e.v,u=c instanceof Error?c.message:"Erreur inconnue lors de la génération",m(u);case 8:return e.p=8,l(!1),e.f(8);case 9:return e.a(2)}},e,null,[[1,7,8,9]])}),function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function u(e){i(o,n,a,u,c,"next",e)}function c(e){i(o,n,a,u,c,"throw",e)}u(void 0)})});return function(e){return t.apply(this,arguments)}}(),[h]);return{isModalOpen:t,openModal:g,closeModal:w,isGenerating:c,previewUrl:f,error:v,format:h,setFormat:b,generatePreview:E,clearPreview:S}}},784:function(e,t,r){r.d(t,{S:function(){return y}});var n=r(594),a=r(75),o=r(49),i=r(351),u=r(335);function c(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",a=r.toStringTag||"@@toStringTag";function o(r,n,a,o){var c=n&&n.prototype instanceof u?n:u,s=Object.create(c.prototype);return l(s,"_invoke",function(r,n,a){var o,u,c,l=0,s=a||[],f=!1,p={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,r){return o=t,u=0,c=e,p.n=r,i}};function d(r,n){for(u=r,c=n,t=0;!f&&l&&!a&&t<s.length;t++){var a,o=s[t],d=p.p,v=o[2];r>3?(a=v===n)&&(c=o[(u=o[4])?5:(u=3,3)],o[4]=o[5]=e):o[0]<=d&&((a=r<2&&d<o[1])?(u=0,p.v=n,p.n=o[1]):d<v&&(a=r<3||o[0]>n||n>v)&&(o[4]=r,o[5]=n,p.n=v,u=0))}if(a||r>1)return i;throw f=!0,n}return function(a,s,v){if(l>1)throw TypeError("Generator is already running");for(f&&1===s&&d(s,v),u=s,c=v;(t=u<2?e:c)||!f;){o||(u?u<3?(u>1&&(p.n=-1),d(u,c)):p.n=c:p.v=c);try{if(l=2,o){if(u||(a="next"),t=o[a]){if(!(t=t.call(o,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,u<2&&(u=0)}else 1===u&&(t=o.return)&&t.call(o),u<2&&(c=TypeError("The iterator does not provide a '"+a+"' method"),u=1);o=e}else if((t=(f=p.n<0)?c:r.call(n,p))!==i)break}catch(t){o=e,u=1,c=t}finally{l=1}}return{value:t,done:f}}}(r,a,o),!0),s}var i={};function u(){}function s(){}function f(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(l(t={},n,function(){return this}),t),d=f.prototype=u.prototype=Object.create(p);function v(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,l(e,a,"GeneratorFunction")),e.prototype=Object.create(d),e}return s.prototype=f,l(d,"constructor",f),l(f,"constructor",s),s.displayName="GeneratorFunction",l(f,a,"GeneratorFunction"),l(d),l(d,a,"Generator"),l(d,n,function(){return this}),l(d,"toString",function(){return"[object Generator]"}),(c=function(){return{w:o,m:v}})()}function l(e,t,r,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}l=function(e,t,r,n){function o(t,r){l(e,t,function(e){return this._invoke(t,r,e)})}t?a?a(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(o("next",0),o("throw",1),o("return",2))},l(e,t,r,n)}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach(function(t){p(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function p(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=d(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=d(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==d(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function v(e,t,r,n,a,o,i){try{var u=e[o](i),c=u.value}catch(e){return void r(e)}u.done?t(c):Promise.resolve(c).then(n,a)}function m(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function i(e){v(o,n,a,i,u,"next",e)}function u(e){v(o,n,a,i,u,"throw",e)}i(void 0)})}}function y(){var e=(0,a.nY)(),t=e.state,r=e.dispatch,l=(0,o.h)(),s=l.canvasWidth,p=l.canvasHeight,v=(0,n.useCallback)(function(){var e;if(null!==(e=window.pdfBuilderData)&&void 0!==e&&e.templateId)return window.pdfBuilderData.templateId.toString();var t=new URLSearchParams(window.location.search).get("template_id");return t||null},[]),y=(0,n.useCallback)(function(){var e=m(c().m(function e(t){var n,a,o,l,s,p,v,m,y,h,b,g,w,S,E,T,A,_,O,P,j,k,D,C;return c().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,o=Date.now(),l="undefined"!=typeof navigator&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor),s="undefined"!=typeof navigator&&/Firefox/.test(navigator.userAgent),p="undefined"!=typeof navigator&&/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/Chromium/.test(navigator.userAgent),v={method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},mode:"cors",credentials:"same-origin"},l?(v.mode="cors",v.cache="no-cache"):s?v.cache="no-cache":p&&(v.mode="cors"),m="".concat(null===(n=window.pdfBuilderData)||void 0===n?void 0:n.ajaxUrl,"?action=pdf_builder_get_template&template_id=").concat(t,"&nonce=").concat(null===(a=window.pdfBuilderData)||void 0===a?void 0:a.nonce,"&t=").concat(o),e.n=1,fetch(m,v);case 1:if((y=e.v).ok){e.n=3;break}return e.n=2,y.text();case 2:throw e.v,new Error("Erreur HTTP ".concat(y.status,": ").concat(y.statusText));case 3:return e.n=4,y.json();case 4:if((h=e.v).success){e.n=5;break}throw new Error(h.data||"Erreur lors du chargement du template");case 5:b=h.data?h.data.template:h.template,g=h.data?h.data.template_name||h.data.name:h.name||h.template_name,b.elements&&b.elements.filter(function(e){return"order_number"===e.type}),w=[],S=null;try{w="string"==typeof b.elements?JSON.parse(b.elements):Array.isArray(b.elements)?b.elements:[],S=b.canvasWidth&&b.canvasHeight?{width:b.canvasWidth,height:b.canvasHeight}:"string"==typeof b.canvas?JSON.parse(b.canvas):b.canvas&&"object"===d(b.canvas)?b.canvas:{width:210,height:297}}catch(c){(0,i.AO)("❌ [LOAD TEMPLATE] Erreur de parsing:",c),w=[],S={width:210,height:297}}E=(0,u.BU)(w),(0,u.rv)(E,"APRÈS CHARGEMENT"),(T=E.map(function(e){var t=f({},e);if("company_logo"===e.type&&!e.src&&!e.logoUrl){var r=e.defaultSrc||"";r&&(t.src=r)}if(t.createdAt)try{var n=new Date(t.createdAt);t.createdAt=isNaN(n.getTime())?new Date:n}catch(o){t.createdAt=new Date}else t.createdAt=new Date;if(t.updatedAt)try{var a=new Date(t.updatedAt);t.updatedAt=isNaN(a.getTime())?new Date:a}catch(i){t.updatedAt=new Date}else t.updatedAt=new Date;return t})).slice(0,3).forEach(function(e,t){});try{b.updated_at?(A=new Date(b.updated_at),isNaN(A.getTime())&&(A=new Date)):A=new Date}catch(G){A=new Date}return T.filter(function(e){return"order_number"===e.type}),r({type:"LOAD_TEMPLATE",payload:{id:t,name:g||b.name,elements:T,canvas:S,lastSaved:A}}),e.a(2,!0);case 6:if(e.p=6,C=e.v,(0,i.AO)("❌ [LOAD TEMPLATE] Erreur lors du chargement:",C),_="undefined"!=typeof navigator&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor),"undefined"!=typeof navigator&&/Firefox/.test(navigator.userAgent),"undefined"!=typeof navigator&&/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/Chromium/.test(navigator.userAgent),!_||!C.message.includes("fetch")){e.n=12;break}return e.p=7,e.n=8,new Promise(function(e){return setTimeout(e,1e3)});case 8:return j={method:"GET",headers:{Accept:"application/json, text/plain, */*","X-Requested-With":"XMLHttpRequest"},mode:"no-cors",cache:"reload"},k="".concat(null===(O=window.pdfBuilderData)||void 0===O?void 0:O.ajaxUrl,"?action=pdf_builder_get_template&template_id=").concat(t,"&nonce=").concat(null===(P=window.pdfBuilderData)||void 0===P?void 0:P.nonce,"&fallback=1&t=").concat(Date.now()),e.n=9,fetch(k,j);case 9:if(!(D=e.v).ok&&0!==D.status){e.n=10;break}return e.a(2,!0);case 10:e.n=12;break;case 11:e.p=11,e.v;case 12:return e.a(2,!1)}},e,null,[[7,11],[0,6]])}));return function(t){return e.apply(this,arguments)}}(),[r]);(0,n.useEffect)(function(){return function(){}},[]),(0,n.useEffect)(function(){var e=v();e&&y(e)},[]);var h=(0,n.useCallback)(m(c().m(function e(){var n,a,o,i,l,f,d,m,y,h;return c().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r({type:"SET_TEMPLATE_SAVING",payload:!0}),e.p=1,l=v()){e.n=2;break}throw new Error("Aucun template chargé pour la sauvegarde");case 2:if(t.template.name&&""!==t.template.name.trim()){e.n=3;break}return e.a(2);case 3:if(null!==(n=window.pdfBuilderData)&&void 0!==n&&n.ajaxUrl){e.n=4;break}throw new Error("URL AJAX non disponible");case 4:if(null!==(a=window.pdfBuilderData)&&void 0!==a&&a.nonce){e.n=5;break}throw new Error("Nonce non disponible");case 5:return f=(0,u.Vt)(t.elements),(0,u.rv)(f,"AVANT SAUVEGARDE"),d={elements:f,canvasWidth:s,canvasHeight:p,version:"1.0"},(m=new FormData).append("action","pdf_builder_save_template"),m.append("template_id",l),m.append("template_name",t.template.name||"Nouveau template"),m.append("template_data",JSON.stringify(d)),m.append("nonce",(null===(o=window.pdfBuilderData)||void 0===o?void 0:o.nonce)||""),e.n=6,fetch((null===(i=window.pdfBuilderData)||void 0===i?void 0:i.ajaxUrl)||"",{method:"POST",body:m});case 6:if((y=e.v).ok){e.n=7;break}throw new Error("Erreur HTTP: ".concat(y.status));case 7:return e.n=8,y.json();case 8:if((h=e.v).success){e.n=9;break}throw new Error(h.data||"Erreur lors de la sauvegarde");case 9:r({type:"SAVE_TEMPLATE",payload:{id:h.data.template_id||h.data.id,name:h.data.name}}),e.n=11;break;case 10:throw e.p=10,e.v;case 11:return e.p=11,r({type:"SET_TEMPLATE_SAVING",payload:!1}),e.f(11);case 12:return e.a(2)}},e,null,[[1,10,11,12]])})),[t.elements,t.template.name,r,s,p,v]),b=(0,n.useCallback)(function(){r({type:"SET_SHOW_PREVIEW_MODAL",payload:!0})},[r]),g=(0,n.useCallback)(function(){r({type:"NEW_TEMPLATE"})},[r]),w=(0,n.useCallback)(function(e){r({type:"SET_TEMPLATE_MODIFIED",payload:e})},[r]),S=(0,n.useCallback)(function(e){r({type:"UPDATE_TEMPLATE_SETTINGS",payload:e})},[r]);return{templateName:t.template.name,templateDescription:t.template.description,templateTags:t.template.tags,canvasWidth:t.template.canvasWidth,canvasHeight:t.template.canvasHeight,marginTop:t.template.marginTop,marginBottom:t.template.marginBottom,showGuides:t.template.showGuides,snapToGrid:t.template.snapToGrid,isNewTemplate:t.template.isNew,isModified:t.template.isModified,isSaving:t.template.isSaving,isLoading:t.template.isLoading,lastSaved:t.template.lastSaved,isEditingExistingTemplate:null!==v(),saveTemplate:h,previewTemplate:b,newTemplate:g,setTemplateModified:w,updateTemplateSettings:S}}},902:function(e,t,r){r.d(t,{K:function(){return p}});var n=r(594),a=r(351);function o(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",a=r.toStringTag||"@@toStringTag";function u(r,n,a,o){var u=n&&n.prototype instanceof l?n:l,s=Object.create(u.prototype);return i(s,"_invoke",function(r,n,a){var o,i,u,l=0,s=a||[],f=!1,p={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,r){return o=t,i=0,u=e,p.n=r,c}};function d(r,n){for(i=r,u=n,t=0;!f&&l&&!a&&t<s.length;t++){var a,o=s[t],d=p.p,v=o[2];r>3?(a=v===n)&&(u=o[(i=o[4])?5:(i=3,3)],o[4]=o[5]=e):o[0]<=d&&((a=r<2&&d<o[1])?(i=0,p.v=n,p.n=o[1]):d<v&&(a=r<3||o[0]>n||n>v)&&(o[4]=r,o[5]=n,p.n=v,i=0))}if(a||r>1)return c;throw f=!0,n}return function(a,s,v){if(l>1)throw TypeError("Generator is already running");for(f&&1===s&&d(s,v),i=s,u=v;(t=i<2?e:u)||!f;){o||(i?i<3?(i>1&&(p.n=-1),d(i,u)):p.n=u:p.v=u);try{if(l=2,o){if(i||(a="next"),t=o[a]){if(!(t=t.call(o,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=o.return)&&t.call(o),i<2&&(u=TypeError("The iterator does not provide a '"+a+"' method"),i=1);o=e}else if((t=(f=p.n<0)?u:r.call(n,p))!==c)break}catch(t){o=e,i=1,u=t}finally{l=1}}return{value:t,done:f}}}(r,a,o),!0),s}var c={};function l(){}function s(){}function f(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(i(t={},n,function(){return this}),t),d=f.prototype=l.prototype=Object.create(p);function v(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,i(e,a,"GeneratorFunction")),e.prototype=Object.create(d),e}return s.prototype=f,i(d,"constructor",f),i(f,"constructor",s),s.displayName="GeneratorFunction",i(f,a,"GeneratorFunction"),i(d),i(d,a,"Generator"),i(d,n,function(){return this}),i(d,"toString",function(){return"[object Generator]"}),(o=function(){return{w:u,m:v}})()}function i(e,t,r,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}i=function(e,t,r,n){function o(t,r){i(e,t,function(e){return this._invoke(t,r,e)})}t?a?a(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(o("next",0),o("throw",1),o("return",2))},i(e,t,r,n)}function u(e,t,r,n,a,o,i){try{var u=e[o](i),c=u.value}catch(e){return void r(e)}u.done?t(c):Promise.resolve(c).then(n,a)}function c(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function i(e){u(o,n,a,i,c,"next",e)}function c(e){u(o,n,a,i,c,"throw",e)}i(void 0)})}}function l(e){return l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l(e)}function s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o,i,u=[],c=!0,l=!1;try{if(o=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=o.call(r)).done)&&(u.push(n.value),u.length!==t);c=!0);}catch(e){l=!0,a=e}finally{try{if(!c&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(l)throw a}}return u}}(e,t)||function(e,t){if(e){if("string"==typeof e)return f(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?f(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function p(e){var t=e.templateId,r=e.elements,i=e.nonce,u=e.autoSaveInterval,f=void 0===u?999999999:u,p=e.onSaveStart,d=e.onSaveSuccess,v=e.onSaveError,m=s((0,n.useState)("idle"),2),y=m[0],h=m[1],b=s((0,n.useState)(null),2),g=b[0],w=b[1],S=s((0,n.useState)(null),2),E=S[0],T=S[1],A=s((0,n.useState)(0),2),_=A[0],O=A[1],P=(0,n.useRef)(""),j=(0,n.useRef)(null),k=(0,n.useRef)(null),D=(0,n.useRef)(null),C=(0,n.useRef)(null),G=(0,n.useRef)(0),x=(0,n.useRef)(!1),I=(0,n.useCallback)(function(e){try{var t=function(e){if(null===e||"object"!==l(e))return e;if(Array.isArray(e))return e.map(t);var r={};for(var n in e)"id"===n||"key"===n||"ref"===n||"_owner"===n||"_store"===n||n.startsWith("__")||"canvas"===n||"context"===n||"updatedAt"===n||"createdAt"===n||"timestamp"===n||"function"==typeof e[n]||(r[n]=t(e[n]));return r},r=e.map(t);return JSON.stringify(r)}catch(n){return""}},[]),N=(0,n.useCallback)(c(o().m(function e(){var n,u,c,l,s,f,m,y,b,g,S,E;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t&&!x.current){e.n=1;break}return e.a(2);case 1:return x.current=!0,n=Date.now(),G.current=n,(0,a.Pr)("[SAVE V2] Début de la sauvegarde manuelle",{templateId:t,elementsCount:r.length}),e.p=2,h("saving"),T(null),O(0),null==p||p(),s=0,C.current=setInterval(function(){s+=20*Math.random(),O(Math.min(90,s))},150),(f=r.map(function(e){var t={};return Object.keys(e).forEach(function(r){"function"==typeof e[r]||r.startsWith("__")||(t[r]=e[r])}),t})).length>0&&((0,a.Pr)("[SAVE V2] Éléments nettoyés à envoyer:",f.length,"éléments"),(0,a.Pr)("[SAVE V2] Premier élément exemple:",f[0]),f.forEach(function(e,t){null==e||e.type,null==e||e.src})),m=(null===(u=window.pdfBuilderData)||void 0===u?void 0:u.ajaxUrl)||"/wp-admin/admin-ajax.php",e.n=3,fetch(m,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({action:"pdf_builder_save_template",nonce:i,template_id:t.toString(),elements:JSON.stringify(f)})});case 3:if((y=e.v).ok){e.n=4;break}throw new Error("HTTP ".concat(y.status));case 4:return e.n=5,y.json();case 5:if(b=e.v,null!==(c=b.data)&&void 0!==c&&c.elements_saved&&((0,a.Pr)("[SAVE V2] Réponse serveur - éléments sauvegardés:",b.data.elements_saved.length),b.data.elements_saved.length>0&&b.data.elements_saved.forEach(function(e,t){null==e||e.type})),b.success){e.n=6;break}throw new Error((null===(g=b.data)||void 0===g?void 0:g.message)||"Erreur serveur");case 6:S=(null===(l=b.data)||void 0===l?void 0:l.saved_at)||(new Date).toISOString(),(0,a.Pr)("[SAVE V2] Sauvegarde réussie à:",S),C.current&&(clearInterval(C.current),C.current=null),O(100),h("saved"),w(S),P.current=I(r),null==d||d(S),D.current&&clearTimeout(D.current),D.current=setTimeout(function(){h("idle"),O(0)},2e3),e.n=8;break;case 7:e.p=7,E=e.v,(0,a.Pr)("[SAVE V2] Erreur de sauvegarde:",null==E?void 0:E.message),(0,a.AO)("[SAVE V2] Erreur:",null==E?void 0:E.message),C.current&&(clearInterval(C.current),C.current=null),O(0),h("error"),T((null==E?void 0:E.message)||"Erreur inconnue"),null==v||v(null==E?void 0:E.message),D.current&&clearTimeout(D.current),D.current=setTimeout(function(){h("idle"),O(0)},3e3);case 8:return e.p=8,x.current=!1,e.f(8);case 9:return e.a(2)}},e,null,[[2,7,8,9]])})),[t,r,i,I,p,d,v]),M=(0,n.useCallback)(c(o().m(function e(){return o().w(function(e){for(;;)switch(e.n){case 0:return j.current&&(clearTimeout(j.current),j.current=null),e.n=1,N();case 1:return e.a(2)}},e)})),[N]),V=(0,n.useCallback)(function(){j.current&&(clearTimeout(j.current),j.current=null),N()},[N]),L=(0,n.useCallback)(function(){T(null),h("idle"),O(0)},[]);return(0,n.useEffect)(function(){if(I(r)!==P.current&&(j.current&&clearTimeout(j.current),"saving"!==y))return j.current=setTimeout(function(){0!==f&&(Date.now()-G.current>=f&&N())},3e3),function(){j.current&&clearTimeout(j.current)}},[r,I,y,f,N]),(0,n.useEffect)(function(){var e=j.current,t=k.current,r=D.current,n=C.current;return function(){e&&clearTimeout(e),t&&clearTimeout(t),r&&clearTimeout(r),n&&clearInterval(n)}},[]),{state:y,isSaving:"saving"===y,lastSavedAt:g,error:E,saveNow:M,triggerSave:V,clearError:L,progress:_}}}}]);