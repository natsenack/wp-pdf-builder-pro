(()=>{"use strict";!function(){const e={ajaxUrl:window.ajaxurl||window.pdfBuilderData?.ajaxurl||"/wp-admin/admin-ajax.php",nonce:window.pdfBuilderData?.nonce||window.pdfBuilderNonce||"",endpoint:"pdf_builder_generate_preview"};async function t(t,r={}){try{const a=t?.template_id||null,n={action:e.endpoint,nonce:e.nonce,data:JSON.stringify({pageOptions:{template:t},previewType:"general",orderNumberToPreview:""}),format:r.format||"png",quality:r.quality||150};a&&(n.template_id=a),a&&(n.template_id=a);const i=await fetch(e.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(n)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const o=r.format||"png";if("pdf"===o){const e=await i.blob();if(0===e.size)throw new Error("Le PDF généré est vide");!e.type.includes("pdf")&&e.type.includes("application/octet-stream");const t=URL.createObjectURL(e);if(!t||"blob:"===t)throw new Error("URL blob invalide créée");return{success:!0,data:{image_url:t,format:"pdf"}}}{const e=await i.json();if(!e.success)throw new Error(e.error||"Erreur lors de la génération du PDF");return{success:!0,data:{image_url:e.data?.image_url||e.image_url,format:o}}}}catch(e){throw new Error(`Erreur backend: ${e.message}`)}}window.pdfPreviewApiClient={generatePreview:function(e,r){t(e).then(e=>{r&&r(e)}).catch(e=>{r&&r({error:e.message})})}},window.pdfPreviewAPI={generateEditorPreview:async function(e,r={}){try{return await t(e,r)}catch(e){const t=function(e="png"){const t=document.createElement("canvas");t.width=800,t.height=600;const r=t.getContext("2d");return r?(r.fillStyle="#ffffff",r.fillRect(0,0,t.width,t.height),r.strokeStyle="#cccccc",r.lineWidth=2,r.strokeRect(0,0,t.width,t.height),r.fillStyle="#666666",r.font="bold 24px Arial",r.textAlign="center",r.fillText("Aperçu PDF",t.width/2,t.height/2-50),r.font="16px Arial",r.fillText("Image placeholder (fallback)",t.width/2,t.height/2+20),t.toDataURL("jpg"===e?"image/jpeg":"image/png")):null}(r.format||"png");if(t)return{success:!0,data:{image_url:t,format:r.format||"png",fallback:!0}};throw e}},generateOrderPreview:async function(e,t,r={}){const a={...e,order_id:t};return this.generateEditorPreview(a,r)}}}(jQuery)})();