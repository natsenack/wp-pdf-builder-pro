
>     public function ajax_get_predefined_templates()
      {
          try {
              // Vérification des permissions
              if (!current_user_can('manage_options')) {
                  wp_send_json_error('Permissions insuffisantes');
              }
  
              // Vérification du nonce
              $nonce_valid = false;
              if (isset($_POST['nonce'])) {
                  $nonce_valid = wp_verify_nonce($_POST['nonce'], 'pdf_builder_templates');
              }
  
              if (!$nonce_valid) {
                  wp_send_json_error('Sécurité: Nonce invalide');
              }
  
              // Récupérer les templates prédéfinis
              $templates = $this->get_predefined_templates();
  
              // Formater la réponse
              $formatted_templates = [];
              foreach ($templates as $template) {
                  $formatted_templates[] = [
                      'name' => $template['name'],
                      'description' => $template['description'] ?? '',
                      'category' => $template['category'] ?? 'general',
                      'tags' => $template['tags'] ?? [],
                      'isPremium' => $template['isPremium'] ?? false,
                      'previewImage' => $template['previewImage'] ?? '',
                      'elementCount' => count($template['elements'] ?? []),
                      'filename' => $template['_metadata']['filename'] ?? '',
                      'isInstalled' => $this->is_predefined_template_installed($template['name'])
                  ];
              }
  
              wp_send_json_success([
                  'templates' => $formatted_templates,
                  'total' => count($formatted_templates)
              ]);
  
          } catch (Exception $e) {
              wp_send_json_error('Erreur lors de la récupération des templates: ' . $e->getMessage());
          }
      }
  
      /**
       * AJAX - Installer un template prédéfini
       */
      public function ajax_install_predefined_template()
      {
          try {
              // Vérification des permissions
              if (!current_user_can('manage_options')) {
                  wp_send_json_error('Permissions insuffisantes');
              }
  
              // Vérification du nonce
              $nonce_valid = false;
              if (isset($_POST['nonce'])) {
                  $nonce_valid = wp_verify_nonce($_POST['nonce'], 'pdf_builder_templates');
              }
  
              if (!$nonce_valid) {
                  wp_send_json_error('Sécurité: Nonce invalide');
              }
  
              // Récupération des paramètres
              $template_name = isset($_POST['template_name']) ? sanitize_text_field($_POST['template_name']) : '';
              $custom_name = isset($_POST['custom_name']) ? sanitize_text_field($_POST['custom_name']) : '';
  
              if (empty($template_name)) {
                  wp_send_json_error('Nom du template requis');
              }
  
              // Installer le template
              $result = $this->install_predefined_template($template_name, $custom_name);
  
              if ($result['success']) {
                  wp_send_json_success([
                      'message' => $result['message'],
                      'template_id' => $result['template_id']
                  ]);
              } else {
                  wp_send_json_error($result['message']);
  
              }
  
          } catch (Exception $e) {
              wp_send_json_error('Erreur lors de l\'installation: ' . $e->getMessage());
          }
      }
  
      /**
       * Régénérer les vignettes de prévisualisation pour tous les templates prédéfinis
       */
      public function regenerate_predefined_thumbnails()
      {
          try {
              error_log('[PDF Builder] Starting thumbnail regeneration');
  
              // Charger PreviewImageAPI pour générer de vraies prévisualisations
              if (!class_exists('WP_PDF_Builder_Pro\Api\PreviewImageAPI')) {
                  error_log('[PDF Builder] PreviewImageAPI class not found');
                  throw new Exception("PreviewImageAPI class not found - plugin not properly initialized");
              }
  
              $preview_api = new \WP_PDF_Builder_Pro\Api\PreviewImageAPI();
              error_log('[PDF Builder] PreviewImageAPI loaded successfully');
  
              // Dossier des templates prédéfinis
              // Depuis src/Managers/, remonter vers la racine du plugin puis aller dans templates/predefined/
              $plugin_root = dirname(dirname(dirname(__FILE__)));
              $templates_dir = $plugin_root . '/templates/predefined/';
              error_log('[PDF Builder] Templates directory: ' . $templates_dir);
  
              $templates = glob($templates_dir . '*.json');
              error_log('[PDF Builder] Found ' . count($templates) . ' template files');
  
              if (empty($templates)) {
                  throw new Exception("Aucun template prédéfini trouvé dans $templates_dir");
              }
  
              $results = [];
              $success_count = 0;
  
              foreach ($templates as $template_file) {
                  $filename = basename($template_file, '.json');
                  error_log('[PDF Builder] Processing template: ' . $filename);
  
                  // Charger le JSON du template
                  $template_json = file_get_contents($template_file);
                  if (!$template_json) {
                      error_log('[PDF Builder] Failed to read template file: ' . $template_file);
                      $results[] = ['filename' => $filename, 'success' => false, 'error' => 'Impossible de lire le fichier'];
                      continue;
                  }
  
                  $template_data = json_decode($template_json, true);
                  if (json_last_error() !== JSON_ERROR_NONE) {
                      error_log('[PDF Builder] JSON decode error for ' . $filename . ': ' . json_last_error_msg());
                      $results[] = ['filename' => $filename, 'success' => false, 'error' => 'JSON invalide: ' . json_last_error_msg()];
                      continue;
                  }
  
                  // Vérifier si c'est un template valide
                  // Supporte les deux formats : structure plate ou avec clé 'template'
                  $has_flat_structure = isset($template_data['canvasWidth']) && isset($template_data['canvasHeight']) && isset($template_data['elements']);
                  $has_nested_structure = isset($template_data['template']) && isset($template_data['template']['canvasWidth']) && isset($template_data['template']['canvasHeight']) && isset($template_data['template']['elements']);
  
                  if (!$has_flat_structure && !$has_nested_structure) {
                      error_log('[PDF Builder] Invalid template structure for ' . $filename);
                      $results[] = ['filename' => $filename, 'success' => false, 'error' => 'Template invalide: champs requis manquants'];
                      continue;
                  }
  
                  // Garder une copie de la structure originale pour la sauvegarde
                  $original_template_data = $template_data;
  
                  // Normaliser la structure pour les générateurs (qui attendent une clé 'template')
                  if ($has_flat_structure && !$has_nested_structure) {
                      $template_data = [
                          'name' => $template_data['name'] ?? $filename,
                          'description' => $template_data['description'] ?? '',
                          'category' => $template_data['category'] ?? 'general',
                          'tags' => $template_data['tags'] ?? [],
                          'version' => $template_data['version'] ?? '1.0.0',
                          'isPremium' => $template_data['isPremium'] ?? false,
                          'previewImage' => $template_data['previewImage'] ?? '',
                          'template' => [
                              'canvasWidth' => $template_data['canvasWidth'],
                              'canvasHeight' => $template_data['canvasHeight'],
                              'orientation' => $template_data['orientation'] ?? 'portrait',
                              'elements' => $template_data['elements'],
                              'variables' => $template_data['variables'] ?? []
                          ]
                      ];
                  }
  
                  try {
                      error_log('[PDF Builder] Generating preview for ' . $filename);
  
                      // Générer une vraie prévisualisation avec PreviewImageAPI
                      $preview_params = [
                          'context' => 'editor',
                          'template_data' => $template_data,
                          'quality' => 75, // Qualité réduite pour vignette
                          'format' => 'png',
                          'order_id' => null
                      ];
  
                      // Générer la vignette
                      $result = $preview_api->generate_with_cache($preview_params);
                      error_log('[PDF Builder] Preview generation result for ' . $filename . ': ' . json_encode($result));
  
                      if ($result && isset($result['image_url'])) {
                          // Mettre à jour le champ previewImage dans le JSON original
                          $original_template_data['previewImage'] = $result['image_url'];
  
                          error_log('[PDF Builder] About to save template file: ' . $template_file);

