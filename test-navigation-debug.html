<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Navigation PDF Builder - Debug</title>
    <script>
        // LOG ABSOLU - Test si le HTML se charge
        console.log('ðŸš€ HTML CHARGÃ‰: DÃ©but du document HTML - TIMESTAMP:', Date.now());
        alert('ðŸš€ HTML chargÃ© et script exÃ©cutÃ©!');
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f1f1f1;
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .pdf-builder-header {
            background: #23282d;
            color: white;
            padding: 20px;
            margin: 0;
        }

        .nav-tab-wrapper {
            border-bottom: 1px solid #ccc;
            margin: 0;
            padding: 0 20px;
            background: #f9f9f9;
        }

        .nav-tab {
            display: inline-block;
            padding: 10px 15px;
            text-decoration: none;
            background: #e5e5e5;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 5px;
            color: #333;
            cursor: pointer;
            position: relative;
            top: 1px;
        }

        .nav-tab:hover {
            background: #ddd;
        }

        .nav-tab-active {
            background: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
        }

        .tab-content-wrapper {
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 400px;
            height: 80vh;
            background: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            overflow-y: auto;
            border-radius: 5px;
            z-index: 10000;
        }

        .debug-panel h3 {
            margin: 0 0 10px 0;
            color: #ff0;
        }

        .clear-debug {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f00;
            color: white;
            border: none;
            padding: 2px 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <header class="pdf-builder-header">
            <h1>ParamÃ¨tres PDF Builder Pro - TEST DEBUG</h1>
        </header>

        <nav class="nav-tab-wrapper wp-clearfix" id="pdf-builder-tabs" role="tablist" aria-label="Onglets des paramÃ¨tres PDF Builder">
            <a href="#general" class="nav-tab nav-tab-active" data-tab="general" role="tab" aria-selected="true" aria-controls="general">GÃ©nÃ©ral</a>
            <a href="#licence" class="nav-tab" data-tab="licence" role="tab" aria-selected="false" aria-controls="licence">Licence</a>
            <a href="#systeme" class="nav-tab" data-tab="systeme" role="tab" aria-selected="false" aria-controls="systeme">SystÃ¨me</a>
            <a href="#acces" class="nav-tab" data-tab="acces" role="tab" aria-selected="false" aria-controls="acces">AccÃ¨s</a>
        </nav>

        <section id="pdf-builder-tab-content" class="tab-content-wrapper" role="tabpanel" aria-live="polite">
            <div id="general" class="tab-content active" role="tabpanel" aria-labelledby="tab-general">
                <h2>Contenu GÃ©nÃ©ral</h2>
                <p>Ceci est l'onglet <strong>GÃ©nÃ©ral</strong>.</p>
                <p>Test de navigation avec logs dÃ©taillÃ©s.</p>
            </div>

            <div id="licence" class="tab-content" role="tabpanel" aria-labelledby="tab-licence">
                <h2>Contenu Licence</h2>
                <p>Ceci est l'onglet <strong>Licence</strong>.</p>
            </div>

            <div id="systeme" class="tab-content" role="tabpanel" aria-labelledby="tab-systeme">
                <h2>Contenu SystÃ¨me</h2>
                <p>Ceci est l'onglet <strong>SystÃ¨me</strong>.</p>
            </div>

            <div id="acces" class="tab-content" role="tabpanel" aria-labelledby="tab-acces">
                <h2>Contenu AccÃ¨s</h2>
                <p>Ceci est l'onglet <strong>AccÃ¨s</strong>.</p>
            </div>
        </section>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel">
        <button class="clear-debug" onclick="clearDebug()">Clear</button>
        <h3>ðŸ”¥ DEBUG LOGS</h3>
        <div id="debug-output"></div>
    </div>

    <!-- Charger settings-tabs.js -->
    <script>
        // LOG ABSOLU - Test si ce script s'exÃ©cute
        console.log('ðŸš€ TEST ABSOLU: DÃ©but du script settings-tabs.js - TIMESTAMP:', Date.now());
        alert('ðŸš€ Script settings-tabs.js chargÃ©!');
    </script>
    <script src="assets/js/settings-tabs.js"></script>
    <script>
        // LOG ABSOLU - Test si settings-tabs.js s'est chargÃ©
        console.log('ðŸš€ TEST ABSOLU: AprÃ¨s chargement de settings-tabs.js - TIMESTAMP:', Date.now());
        alert('ðŸš€ AprÃ¨s chargement de settings-tabs.js!');
    </script>

    <!-- Script inline avec logs dÃ©taillÃ©s -->
    <script>
    (function() {
        'use strict';

        // Rediriger console.log vers le panel debug
        const originalLog = console.log;
        const debugOutput = document.getElementById('debug-output');

        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            const div = document.createElement('div');
            div.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
            div.style.marginBottom = '2px';
            div.style.borderBottom = '1px solid #333';
            div.style.paddingBottom = '2px';
            debugOutput.appendChild(div);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        };

        window.clearDebug = function() {
            debugOutput.innerHTML = '';
        };

        console.log('PDF Builder: Script de navigation chargÃ©');

        // ðŸ”¥ LOGS RACINE - Diagnostic complet du systÃ¨me de navigation
        console.log('ðŸ”¥ ROOT NAVIGATION: Script de navigation chargÃ© - TIMESTAMP:', Date.now());

        // LOG RACINE - Ã‰tat initial du DOM
        console.log('ðŸ”¥ ROOT NAVIGATION: VÃ©rification DOM initial');
        const rootTabsContainer = document.getElementById('pdf-builder-tabs');
        const rootContentContainer = document.getElementById('pdf-builder-tab-content');
        console.log('ðŸ”¥ ROOT NAVIGATION: Container tabs trouvÃ©:', !!rootTabsContainer);
        console.log('ðŸ”¥ ROOT NAVIGATION: Container content trouvÃ©:', !!rootContentContainer);

        if (rootTabsContainer) {
            const rootTabButtons = rootTabsContainer.querySelectorAll('.nav-tab');
            console.log('ðŸ”¥ ROOT NAVIGATION: Nombre de boutons onglet:', rootTabButtons.length);
            rootTabButtons.forEach((btn, index) => {
                console.log('ðŸ”¥ ROOT NAVIGATION: Bouton', index + 1, '- data-tab:', btn.getAttribute('data-tab'), '- text:', btn.textContent.trim());
            });
        }

        if (rootContentContainer) {
            const rootTabContents = rootContentContainer.querySelectorAll('.tab-content');
            console.log('ðŸ”¥ ROOT NAVIGATION: Nombre de contenus onglet:', rootTabContents.length);
            rootTabContents.forEach((content, index) => {
                console.log('ðŸ”¥ ROOT NAVIGATION: Contenu', index + 1, '- id:', content.id, '- active:', content.classList.contains('active'));
            });
        }

        // LOG RACINE - Ã‰tat des variables globales
        console.log('ðŸ”¥ ROOT NAVIGATION: Ã‰tat des variables globales au chargement:');
        console.log('ðŸ”¥ ROOT NAVIGATION: window.PDF_BUILDER_TABS_INITIALIZED:', window.PDF_BUILDER_TABS_INITIALIZED);
        console.log('ðŸ”¥ ROOT NAVIGATION: window.PDFBuilderTabsAPI:', !!window.PDFBuilderTabsAPI);
        console.log('ðŸ”¥ ROOT NAVIGATION: window.PDFBuilderInlineFallbackBound:', window.PDFBuilderInlineFallbackBound);

        // LOG RACINE - Ã‰vÃ©nements de clic globaux
        document.addEventListener('click', function(e) {
            if (e.target.closest && e.target.closest('#pdf-builder-tabs')) {
                console.log('ðŸ”¥ ROOT NAVIGATION: Clic dÃ©tectÃ© dans #pdf-builder-tabs:', {
                    target: e.target.tagName + (e.target.id ? '#' + e.target.id : '') + (e.target.className ? '.' + e.target.className : ''),
                    closestNavTab: !!e.target.closest('.nav-tab'),
                    dataTab: e.target.closest('.nav-tab') ? e.target.closest('.nav-tab').getAttribute('data-tab') : null,
                    timestamp: Date.now(),
                    eventPhase: e.eventPhase,
                    defaultPrevented: e.defaultPrevented,
                    propagationStopped: e.cancelBubble
                });
            }
        }, true); // Capture phase pour voir tous les clics

        // LOG RACINE - Changements DOM
        const rootObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.target.id === 'pdf-builder-tabs' || mutation.target.id === 'pdf-builder-tab-content') {
                    console.log('ðŸ”¥ ROOT NAVIGATION: Mutation DOM dÃ©tectÃ©e:', {
                        type: mutation.type,
                        target: mutation.target.id,
                        addedNodes: mutation.addedNodes.length,
                        removedNodes: mutation.removedNodes.length,
                        attributeName: mutation.attributeName,
                        timestamp: Date.now()
                    });
                }
            });
        });

        if (rootTabsContainer) {
            rootObserver.observe(rootTabsContainer, { childList: true, subtree: true, attributes: true });
        }
        if (rootContentContainer) {
            rootObserver.observe(rootContentContainer, { childList: true, subtree: true, attributes: true });
        }

        // LOG RACINE - Chargement des scripts
        window.addEventListener('load', function() {
            console.log('ðŸ”¥ ROOT NAVIGATION: Window load - Ã‰tat final:');
            console.log('ðŸ”¥ ROOT NAVIGATION: PDF_BUILDER_TABS_INITIALIZED:', window.PDF_BUILDER_TABS_INITIALIZED);
            console.log('ðŸ”¥ ROOT NAVIGATION: PDFBuilderTabsAPI:', !!window.PDFBuilderTabsAPI);
            console.log('ðŸ”¥ ROOT NAVIGATION: PDFBuilderInlineFallbackBound:', window.PDFBuilderInlineFallbackBound);

            // VÃ©rifier les event listeners
            const tabs = document.querySelectorAll('#pdf-builder-tabs .nav-tab');
            console.log('ðŸ”¥ ROOT NAVIGATION: VÃ©rification des event listeners sur', tabs.length, 'onglets:');
            tabs.forEach((tab, index) => {
                const listeners = tab._pdfBuilderInlineFallbackHandler || 'AUCUN';
                console.log('ðŸ”¥ ROOT NAVIGATION: Onglet', index + 1, '- data-tab:', tab.getAttribute('data-tab'), '- handler:', typeof listeners);
            });
        });

        // Fonction principale d'initialisation
        function initTabNavigation() {
            console.log('ðŸ“‹ INLINE NAVIGATION: initTabNavigation appelÃ©e - TIMESTAMP:', Date.now());

            // Si le manager principal est prÃ©sent, ne pas attacher nos propres handlers
            if (window.PDF_BUILDER_TABS_INITIALIZED || (window.PDFBuilderTabsAPI && typeof window.PDFBuilderTabsAPI.switchToTab === 'function')) {
                console.log('ðŸ“‹ INLINE NAVIGATION: Manager global dÃ©tectÃ©, fallback inline dÃ©sactivÃ©');
                try {
                    const saved = (window.PDFBuilderTabsAPI && window.PDFBuilderTabsAPI.getActiveTab) ? window.PDFBuilderTabsAPI.getActiveTab() : null;
                    if (saved && window.PDFBuilderTabsAPI && typeof window.PDFBuilderTabsAPI.switchToTab === 'function') {
                        window.PDFBuilderTabsAPI.switchToTab(saved);
                    }
                } catch (e) {
                    console.log('ðŸ“‹ INLINE NAVIGATION: Erreur lors de la synchronisation avec le manager global', e && e.message ? e.message : e);
                }
                return true;
            }
            console.log('ðŸ“‹ INLINE NAVIGATION: Initialisation forcÃ©e de la navigation');

            const tabsContainer = document.getElementById('pdf-builder-tabs');
            const contentContainer = document.getElementById('pdf-builder-tab-content');

            if (!tabsContainer || !contentContainer) {
                console.error('ðŸ“‹ INLINE NAVIGATION: Conteneurs non trouvÃ©s, retry dans 1s...');
                setTimeout(initTabNavigation, 1000);
                return;
            }

            const tabs = tabsContainer.querySelectorAll('.nav-tab');
            const contents = contentContainer.querySelectorAll('.tab-content');

            console.log('ðŸ“‹ INLINE NAVIGATION: TrouvÃ©', tabs.length, 'onglets et', contents.length, 'contenus');

            if (tabs.length === 0 || contents.length === 0) {
                console.error('ðŸ“‹ INLINE NAVIGATION: Ã‰lÃ©ments manquants, retry dans 1s...');
                setTimeout(initTabNavigation, 1000);
                return;
            }

            // Fonction de changement d'onglet
            function switchTab(tabId) {
                console.log('ðŸ“‹ INLINE NAVIGATION: switchTab appelÃ©e avec tabId:', tabId, '- TIMESTAMP:', Date.now());

                // DÃ©sactiver tous les onglets
                tabs.forEach(function(tab) {
                    tab.classList.remove('nav-tab-active');
                    tab.setAttribute('aria-selected', 'false');
                });

                // DÃ©sactiver tous les contenus
                contents.forEach(function(content) {
                    content.classList.remove('active');
                });

                // Activer l'onglet cible
                const targetTab = tabsContainer.querySelector('[data-tab="' + tabId + '"]');
                const targetContent = document.getElementById(tabId);

                if (targetTab) {
                    targetTab.classList.add('nav-tab-active');
                    targetTab.setAttribute('aria-selected', 'true');
                    console.log('ðŸ“‹ INLINE NAVIGATION: Onglet', tabId, 'activÃ©');
                }

                if (targetContent) {
                    targetContent.classList.add('active');
                    console.log('ðŸ“‹ INLINE NAVIGATION: Contenu', tabId, 'affichÃ©');
                }
            }

            // Gestionnaire de clic
            function handleTabClick(event) {
                    event.preventDefault();

                const tabId = this.getAttribute('data-tab');
                console.log('ðŸ“‹ INLINE NAVIGATION: handleTabClick dÃ©clenchÃ© - tabId:', tabId, '- event.target:', event.target, '- TIMESTAMP:', Date.now());

                if (tabId) {
                    switchTab(tabId);
                }
            }

            // Attacher les Ã©vÃ©nements - FORCER l'attachement
            console.log('ðŸ“‹ INLINE NAVIGATION: Attachement des Ã©vÃ©nements...');
            tabs.forEach(function(tab, index) {
                // Supprimer les anciens Ã©vÃ©nements pour Ã©viter les doublons (si prÃ©sent)
                try { if (tab._pdfBuilderInlineFallbackHandler && typeof tab._pdfBuilderInlineFallbackHandler === 'function') { tab.removeEventListener('click', tab._pdfBuilderInlineFallbackHandler); } } catch (e) {}
                // Attacher le nouvel Ã©vÃ©nement et conserver une rÃ©fÃ©rence pour que le manager canonical puisse l'enlever si besoin
                tab._pdfBuilderInlineFallbackHandler = handleTabClick;
                tab.addEventListener('click', tab._pdfBuilderInlineFallbackHandler);
                console.log('ðŸ“‹ INLINE NAVIGATION: Ã‰vÃ©nement attachÃ© Ã  onglet', index + 1, ':', tab.getAttribute('data-tab'));
            });

            // Bouton de sauvegarde
            const saveBtn = document.getElementById('pdf-builder-save-all');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    alert('Sauvegarde globale Ã  implÃ©menter');
                });
                console.log('ðŸ“‹ INLINE NAVIGATION: Bouton de sauvegarde configurÃ©');
            }

            // Activer l'onglet par dÃ©faut
            const activeTab = tabsContainer.querySelector('.nav-tab-active');
            if (activeTab) {
                const activeTabId = activeTab.getAttribute('data-tab');
                if (activeTabId) {
                    switchTab(activeTabId);
                }
            }

            console.log('ðŸ“‹ INLINE NAVIGATION: Navigation initialisÃ©e avec succÃ¨s!');
            return true;
        }

        // ExÃ©cution contrÃ´lÃ©e: attendre le manager canonical avant d'attacher nos propres handlers
        console.log('ðŸ“‹ INLINE NAVIGATION: Tentative d\'initialisation contrÃ´lÃ©e (attente du manager canonical)...');

        // Pour Ã©viter le double-binding, attendre que window.PDFBuilderTabsAPI soit prÃ©sent
        // Essayer pendant 5 secondes (250ms * 20). Si le canonical n'arrive pas, on bind le fallback.
        (function waitForCanonicalAndInit() {
            var attempts = 0;
            var maxAttempts = 20; // 20 * 250ms = 5s

            function check() {
                attempts++;
                console.log('ðŸ“‹ INLINE NAVIGATION: Tentative', attempts, '/', maxAttempts, '- Ã‰tat:', {
                    PDF_BUILDER_TABS_INITIALIZED: window.PDF_BUILDER_TABS_INITIALIZED,
                    PDFBuilderTabsAPI: !!window.PDFBuilderTabsAPI,
                    PDFBuilderInlineFallbackBound: window.PDFBuilderInlineFallbackBound,
                    timestamp: Date.now()
                });

                // Si le manager canonical est prÃ©sent, on l'utilise et on synchronise l'Ã©tat
                if (window.PDF_BUILDER_TABS_INITIALIZED || (window.PDFBuilderTabsAPI && typeof window.PDFBuilderTabsAPI.switchToTab === 'function')) {
                    console.log('ðŸ“‹ INLINE NAVIGATION: Manager global dÃ©tectÃ© pendant attente, fallback inline dÃ©sactivÃ©');
                    try {
                        const saved = (window.PDFBuilderTabsAPI && window.PDFBuilderTabsAPI.getActiveTab) ? window.PDFBuilderTabsAPI.getActiveTab() : null;
                        if (saved && window.PDFBuilderTabsAPI && typeof window.PDFBuilderTabsAPI.switchToTab === 'function') {
                            window.PDFBuilderTabsAPI.switchToTab(saved);
                        }
                    } catch (e) {
                        console.log('ðŸ“‹ INLINE NAVIGATION: Erreur lors de la synchronisation avec le manager global', e && e.message ? e.message : e);
                    }
                    return;
                }

                if (attempts >= maxAttempts) {
                    // Pas de manager canonical aprÃ¨s attente raisonnable: binder notre fallback (une seule fois)
                    if (!window.PDFBuilderInlineFallbackBound) {
                        console.log('ðŸ“‹ INLINE NAVIGATION: Aucune dÃ©tection du manager canonical â€” binding fallback (inline)');
                        initTabNavigation();
                        window.PDFBuilderInlineFallbackBound = true; // Guard global pour Ã©viter multiples binds
                    } else {
                        console.log('ðŸ“‹ INLINE NAVIGATION: Fallback inline dÃ©jÃ  attachÃ©, skipping');
                    }
                    return;
                }

                // RÃ©essayer plus tard
                setTimeout(check, 250);
            }

            // Initial check + event-based triggers
            check();
            document.addEventListener('DOMContentLoaded', function() { setTimeout(check, 100); });
            window.addEventListener('load', function() { setTimeout(check, 100); });
        })();

        // Et aussi au chargement complet de la page
        window.addEventListener('load', function() {
            console.log('ðŸ“‹ INLINE NAVIGATION: Page chargÃ©e, vÃ©rification finale...');
            setTimeout(initTabNavigation, 100);
        });

    })();
    </script>
</body>
</html>