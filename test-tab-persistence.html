<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Persistance Onglets</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .nav-tab { display: inline-block; padding: 10px 20px; background: #f1f1f1; border: 1px solid #ddd; cursor: pointer; margin-right: 5px; }
        .nav-tab-active { background: #007cba; color: white; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ddd; margin-top: 20px; }
        .tab-content.active { display: block; }
        .debug { background: #f9f9f9; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Test Persistance Onglets PDF Builder</h1>

    <div class="nav-tabs">
        <a href="#general" class="nav-tab" data-tab="general">Général</a>
        <a href="#licence" class="nav-tab" data-tab="licence">Licence</a>
        <a href="#systeme" class="nav-tab" data-tab="systeme">Système</a>
        <a href="#contenu" class="nav-tab" data-tab="contenu">Contenu</a>
    </div>

    <div id="general" class="tab-content">
        <h2>Onglet Général</h2>
        <p>Contenu de l'onglet général.</p>
    </div>

    <div id="licence" class="tab-content">
        <h2>Onglet Licence</h2>
        <p>Contenu de l'onglet licence.</p>
    </div>

    <div id="systeme" class="tab-content">
        <h2>Onglet Système</h2>
        <p>Contenu de l'onglet système.</p>
    </div>

    <div id="contenu" class="tab-content">
        <h2>Onglet Contenu</h2>
        <p>Contenu de l'onglet contenu.</p>
    </div>

    <div class="debug">
        <h3>Debug Info</h3>
        <div id="debug-info">
            Chargement...
        </div>
        <button onclick="clearStorage()">Effacer localStorage</button>
        <button onclick="reloadPage()">Recharger la page</button>
    </div>

    <script>
        // Copie de la logique du PDF Builder
        function initializeTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');

            // Hide all tab contents
            contents.forEach(function(content) {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            // Add click listeners to tabs
            tabs.forEach(function(tab) {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('href').substring(1);
                    setActiveTab(target);
                });
            });

            // Fonction pour activer un onglet spécifique
            function setActiveTab(targetTab, saveToStorage = true) {
                // Remove active classes from all tabs and contents
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('nav-tab-active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });

                // Find target tab and content
                const activeTab = document.querySelector('.nav-tab[href="#' + targetTab + '"]');
                const activeContent = document.getElementById(targetTab);

                if (activeTab && activeContent) {
                    // Add active classes to target tab and content
                    activeTab.classList.add('nav-tab-active');
                    activeContent.classList.add('active');
                    activeContent.style.display = 'block';

                    // Update URL hash
                    if (window.location.hash.substring(1) !== targetTab) {
                        history.replaceState(null, null, '#' + targetTab);
                    }

                    // Save active tab to localStorage for persistence across reloads
                    if (saveToStorage) {
                        localStorage.setItem('pdf-builder-active-tab', targetTab);
                        localStorage.setItem('pdf-builder-active-tab-time', Date.now());
                    }

                    updateDebugInfo();
                    return true;
                } else {
                    console.error('Could not find tab or content for target:', targetTab);
                    return false;
                }
            }

            // Exposer la fonction setActiveTab globalement
            window.setActiveTab = setActiveTab;

            // Déterminer l'onglet à activer au chargement
            const hash = window.location.hash.substring(1);
            let targetTab = 'general'; // Default tab

            // Priority order: localStorage > hash > default (pour rester sur l'onglet actif après rechargement)
            const savedTab = localStorage.getItem('pdf-builder-active-tab');
            if (savedTab) {
                // Validate that the saved tab corresponds to an existing tab
                const tabExists = document.querySelector('.nav-tab[href="#' + savedTab + '"]');
                if (tabExists) {
                    targetTab = savedTab;
                    console.log('Using saved tab from localStorage:', targetTab);
                } else {
                    console.warn('Saved tab not found:', savedTab, '- checking hash');
                }
            }

            // Si pas de localStorage valide, essayer le hash (pour les liens directs)
            if (targetTab === 'general' && hash) {
                const tabExists = document.querySelector('.nav-tab[href="#' + hash + '"]');
                if (tabExists) {
                    targetTab = hash;
                    console.log('Using hash from URL:', targetTab);
                } else {
                    console.warn('Hash not found for tab:', hash, '- using default');
                }
            }

            // Activer l'onglet déterminé (sans sauvegarder dans localStorage pour éviter la boucle)
            setActiveTab(targetTab, false);

            // Écouter les changements de hash dans l'URL
            window.addEventListener('hashchange', function() {
                const newHash = window.location.hash.substring(1);
                if (newHash && newHash !== targetTab) {
                    const tabExists = document.querySelector('.nav-tab[href="#' + newHash + '"]');
                    if (tabExists) {
                        targetTab = newHash;
                        setActiveTab(targetTab);
                    }
                }
            });

            updateDebugInfo();
        }

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            const savedTab = localStorage.getItem('pdf-builder-active-tab');
            const savedTime = localStorage.getItem('pdf-builder-active-tab-time');
            const currentHash = window.location.hash;
            const activeTab = document.querySelector('.nav-tab-active');

            debugInfo.innerHTML = `
                <strong>localStorage 'pdf-builder-active-tab':</strong> ${savedTab || 'null'}<br>
                <strong>Timestamp:</strong> ${savedTime ? new Date(parseInt(savedTime)).toLocaleString() : 'null'}<br>
                <strong>URL Hash:</strong> ${currentHash || 'null'}<br>
                <strong>Onglet actif:</strong> ${activeTab ? activeTab.getAttribute('data-tab') : 'null'}<br>
                <strong>Contenu actif:</strong> ${document.querySelector('.tab-content.active') ? document.querySelector('.tab-content.active').id : 'null'}
            `;
        }

        function clearStorage() {
            localStorage.removeItem('pdf-builder-active-tab');
            localStorage.removeItem('pdf-builder-active-tab-time');
            updateDebugInfo();
            alert('localStorage effacé !');
        }

        function reloadPage() {
            window.location.reload();
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTabs);
        } else {
            initializeTabs();
        }
    </script>
</body>
</html>