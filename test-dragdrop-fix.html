<!DOCTYPE html>
<html>
<head>
    <title>Test Drag & Drop - PDF Builder Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .library {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .library h2 {
            margin-top: 0;
            color: #333;
        }
        
        .element-item {
            padding: 10px;
            margin: 5px 0;
            background: #f0f7ff;
            border: 2px solid #007bff;
            border-radius: 4px;
            cursor: grab;
            user-select: none;
            transition: all 0.2s;
        }
        
        .element-item:hover {
            background: #e6f2ff;
            transform: translateY(-2px);
        }
        
        .element-item.dragging {
            opacity: 0.5;
        }
        
        .canvas-area {
            flex: 2;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            min-height: 500px;
            border: 2px dashed #ccc;
        }
        
        .canvas-area.drag-over {
            background: #f0ffd8;
            border-color: #007bff;
        }
        
        .canvas {
            width: 100%;
            height: 500px;
            border: 1px solid #e0e0e0;
            background: white;
            cursor: crosshair;
        }
        
        .log {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .log-entry.success {
            color: #28a745;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
        
        .log-entry.info {
            color: #007bff;
        }
        
        .controls {
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .status.ok {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Drag & Drop - PDF Builder Pro</h1>
    
    <div class="controls">
        <button onclick="clearLog()">üßπ Clear Log</button>
        <button onclick="testDragSimulation()">üéØ Test Drag Simulation</button>
        <button onclick="location.reload()">üîÑ Reload Page</button>
    </div>
    
    <div id="status" class="status ok">
        ‚úÖ Test environment ready. Drag an element from the library to the canvas.
    </div>
    
    <div class="test-container">
        <div class="library">
            <h2>üìö Element Library</h2>
            <div class="element-item" draggable="true" data-element-type="text">
                üìù Text Element
            </div>
            <div class="element-item" draggable="true" data-element-type="rectangle">
                ‚ñ≠ Rectangle Shape
            </div>
            <div class="element-item" draggable="true" data-element-type="circle">
                ‚óè Circle Shape
            </div>
            <div class="element-item" draggable="true" data-element-type="image">
                üñºÔ∏è Image Element
            </div>
            <div class="element-item" draggable="true" data-element-type="company_logo">
                üè¢ Company Logo
            </div>
            <div class="element-item" draggable="true" data-element-type="product_table">
                üìã Product Table
            </div>
        </div>
        
        <div class="canvas-area" id="canvasArea">
            <h2>üìÑ Canvas Area</h2>
            <canvas id="canvas" class="canvas"></canvas>
        </div>
    </div>
    
    <h2>üìä Event Log</h2>
    <div id="log" class="log">
        <div class="log-entry info">Waiting for events...</div>
    </div>
    
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const canvasArea = document.getElementById('canvasArea');
        const logDiv = document.getElementById('log');
        
        // Setup canvas
        canvas.width = canvasArea.offsetWidth - 40;
        canvas.height = 500;
        
        let draggedElement = null;
        let dragOffset = { x: 0, y: 0 };
        let isDragging = false;
        
        // Add event listeners to library items
        document.querySelectorAll('.element-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);
        });
        
        // Add events to canvas area
        canvas.addEventListener('dragover', handleDragOver);
        canvas.addEventListener('drop', handleDrop);
        canvas.addEventListener('dragleave', handleDragLeave);
        
        function handleDragStart(e) {
            const elementType = e.target.getAttribute('data-element-type');
            log('info', `üéØ Drag Start: ${elementType}`);
            
            draggedElement = {
                type: elementType,
                label: e.target.textContent.trim()
            };
            
            isDragging = true;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('application/json', JSON.stringify(draggedElement));
            
            log('success', `‚úÖ Element ready to drag: ${elementType}`);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            
            const rect = canvas.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            if (!canvasArea.classList.contains('drag-over')) {
                canvasArea.classList.add('drag-over');
                log('info', `üìç Drag Over Canvas: (${Math.round(dragOffset.x)}, ${Math.round(dragOffset.y)})`);
            }
            
            render();
        }
        
        function handleDragLeave(e) {
            if (e.target === canvas) {
                canvasArea.classList.remove('drag-over');
                log('info', '‚Ü©Ô∏è Drag Left Canvas');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            canvasArea.classList.remove('drag-over');
            
            if (draggedElement) {
                log('success', `‚úÖ DROP SUCCESSFUL: ${draggedElement.type} at (${Math.round(dragOffset.x)}, ${Math.round(dragOffset.y)})`);
                log('info', `‚úÖ Element would be added to canvas`);
            } else {
                log('error', '‚ùå DROP FAILED: No dragged element');
            }
            
            draggedElement = null;
            isDragging = false;
            render();
        }
        
        function handleDragEnd(e) {
            isDragging = false;
            e.target.classList.remove('dragging');
            canvasArea.classList.remove('drag-over');
            log('info', 'üèÅ Drag End');
            render();
        }
        
        function render() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            for (let x = 0; x < canvas.width; x += 20) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += 20) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Draw drag preview if dragging
            if (isDragging && draggedElement && dragOffset.x > 0) {
                try {
                    ctx.save();
                    
                    // Draw preview rectangle
                    ctx.globalAlpha = 0.7;
                    ctx.strokeStyle = '#007bff';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    
                    const w = 100;
                    const h = 50;
                    const x = dragOffset.x - w / 2;
                    const y = dragOffset.y - h / 2;
                    
                    ctx.strokeRect(x, y, w, h);
                    
                    // Draw label
                    ctx.globalAlpha = 1;
                    ctx.fillStyle = '#007bff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(draggedElement.type, x + w / 2, y + h / 2);
                    
                    ctx.restore();
                    
                    log('success', '‚úÖ Preview rendered successfully (drawDragPreview NOT called)');
                } catch (error) {
                    log('error', `‚ùå Render Error: ${error.message}`);
                    updateStatus('error', `‚ùå Render Error: ${error.message}`);
                }
            }
        }
        
        function log(type, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = '<div class="log-entry info">Log cleared</div>';
        }
        
        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        function testDragSimulation() {
            log('info', 'üß™ Starting drag simulation test...');
            
            // Test 1: Check if drawDragPreview would be called
            log('info', 'üìã Test 1: Verifying render() method exists');
            try {
                const testCanvas = document.createElement('canvas');
                const testCtx = testCanvas.getContext('2d');
                
                // Simulate drag state
                isDragging = true;
                draggedElement = { type: 'test-element' };
                dragOffset = { x: 100, y: 100 };
                
                // Call render
                render();
                
                log('success', '‚úÖ Test 1 PASSED: render() called successfully without errors');
                updateStatus('ok', '‚úÖ TEST PASSED: No "drawDragPreview is not a function" error!');
            } catch (error) {
                log('error', `‚ùå Test 1 FAILED: ${error.message}`);
                updateStatus('error', `‚ùå TEST FAILED: ${error.message}`);
            }
            
            // Test 2: Verify drag preview renders
            log('info', 'üìã Test 2: Verifying drag preview renders correctly');
            try {
                const canvasContent = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                const hasContent = canvasContent.some(pixel => pixel !== 0);
                
                if (hasContent) {
                    log('success', '‚úÖ Test 2 PASSED: Drag preview rendered to canvas');
                } else {
                    log('info', '‚ö†Ô∏è Test 2 INFO: Canvas appears empty (expected if no drag active)');
                }
            } catch (error) {
                log('error', `‚ùå Test 2 FAILED: ${error.message}`);
            }
            
            // Reset state
            isDragging = false;
            draggedElement = null;
            render();
            
            log('success', '‚úÖ All tests completed!');
        }
        
        // Initial render
        render();
        log('info', '‚úÖ Drag & Drop test environment initialized');
        log('info', 'üìù Fix Applied: Removed duplicate render() method with non-existent drawDragPreview() call');
    </script>
</body>
</html>
