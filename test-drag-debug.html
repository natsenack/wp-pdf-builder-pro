<!DOCTYPE html>
<html>
<head>
    <title>Drag & Drop Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        #test-logs { border: 1px solid #888; padding: 10px; height: 400px; overflow-y: auto; background: #252526; margin-bottom: 20px; }
        .log-line { margin: 2px 0; font-size: 12px; }
        .log-info { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-success { color: #6a9955; }
        .log-warn { color: #d7ba7d; }
        #elements-container { border: 1px solid #666; padding: 10px; margin: 10px 0; background: #2d2d30; }
        .element-item { 
            display: inline-block; 
            padding: 8px 12px; 
            margin: 5px; 
            background: #007acc; 
            color: white; 
            cursor: move; 
            border-radius: 3px;
            user-select: none;
        }
        .element-item.dragging { opacity: 0.5; background: #005a9c; }
        .element-category-title { 
            font-weight: bold; 
            margin-top: 10px; 
            margin-bottom: 5px;
            color: #ce9178;
        }
        #canvas-drop-zone {
            border: 2px dashed #888;
            padding: 20px;
            height: 300px;
            background: #3c3c3c;
            margin-top: 20px;
        }
        #canvas-drop-zone.drag-over {
            background: #2d4a4d;
            border-color: #4ec9b0;
        }
        button { padding: 10px; margin: 5px; background: #007acc; color: white; border: none; cursor: pointer; border-radius: 3px; }
        button:hover { background: #0098ff; }
    </style>
</head>
<body>
    <h2>üêõ Drag & Drop Debug Tool</h2>
    
    <button onclick="testElements()">Test Elements Existence</button>
    <button onclick="clearLogs()">Clear Logs</button>
    <button onclick="testDragStart()">Test Drag Start Manually</button>
    
    <div id="test-logs"></div>
    
    <h3>Elements Container</h3>
    <div id="elements-container"></div>
    
    <h3>Canvas Drop Zone</h3>
    <div id="canvas-drop-zone">Drop zone - Drag elements here</div>
    
    <script>
        const logsDiv = document.getElementById('test-logs');
        
        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            const time = new Date().toLocaleTimeString();
            line.textContent = `[${time}] ${message}`;
            logsDiv.appendChild(line);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLogs() {
            logsDiv.innerHTML = '';
            log('Logs cleared', 'info');
        }
        
        function testElements() {
            log('=== Testing Elements ===', 'info');
            
            const container = document.getElementById('elements-container');
            log(`Container exists: ${!!container}`, container ? 'success' : 'error');
            
            if (container) {
                const items = container.querySelectorAll('.element-item');
                log(`Found ${items.length} .element-item elements`, items.length > 0 ? 'success' : 'warn');
                
                if (items.length > 0) {
                    items.forEach((item, idx) => {
                        const type = item.getAttribute('data-element-type');
                        const draggable = item.getAttribute('draggable');
                        const className = item.className;
                        log(`  Item ${idx}: type="${type}", draggable="${draggable}", class="${className}"`, 'info');
                    });
                } else {
                    log('No elements found! Checking structure...', 'warn');
                    const categories = container.querySelectorAll('.element-category');
                    log(`  Found ${categories.length} .element-category divs`, 'info');
                    categories.forEach((cat, idx) => {
                        const title = cat.querySelector('.element-category-title')?.textContent;
                        const items = cat.querySelectorAll('div');
                        log(`    Category ${idx}: "${title}", ${items.length} children`, 'info');
                    });
                }
            }
        }
        
        function testDragStart() {
            log('=== Testing Drag Start Manually ===', 'info');
            
            const container = document.getElementById('elements-container');
            const items = container.querySelectorAll('.element-item');
            
            if (items.length === 0) {
                log('No items to drag test!', 'error');
                return;
            }
            
            const item = items[0];
            log(`Testing drag on: "${item.textContent}"`, 'info');
            
            const dragstartEvent = new DragEvent('dragstart', {
                bubbles: true,
                cancelable: true,
                view: window
            });
            
            log('Creating mock dataTransfer...', 'info');
            dragstartEvent.dataTransfer = {
                data: {},
                setData: function(type, data) {
                    log(`  setData called: type="${type}", data length=${data.length}`, 'success');
                    this.data[type] = data;
                },
                getData: function(type) {
                    return this.data[type] || '';
                },
                effectAllowed: 'none'
            };
            
            log('Dispatching dragstart event...', 'info');
            item.dispatchEvent(dragstartEvent);
            log('dragstart event dispatched', 'success');
        }
        
        // Initialize container with test elements
        function initializeTestElements() {
            log('Initializing test elements...', 'info');
            
            const container = document.getElementById('elements-container');
            const elements = {
                'text': [
                    { type: 'heading', label: 'Heading', icon: 'H' },
                    { type: 'paragraph', label: 'Paragraph', icon: 'P' }
                ],
                'shapes': [
                    { type: 'rectangle', label: 'Rectangle', icon: '‚ñ≠' },
                    { type: 'circle', label: 'Circle', icon: '‚óã' }
                ]
            };
            
            container.innerHTML = '';
            
            for (const category in elements) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'element-category';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'element-category-title';
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);
                
                elements[category].forEach(element => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'element-item';
                    itemDiv.draggable = true;
                    itemDiv.setAttribute('data-element-type', element.type);
                    itemDiv.setAttribute('data-element', JSON.stringify(element));
                    itemDiv.textContent = `${element.icon} ${element.label}`;
                    
                    // Add dragstart listener
                    itemDiv.addEventListener('dragstart', (e) => {
                        log(`dragstart fired on: ${element.label}`, 'success');
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('application/json', JSON.stringify({
                            type: 'new-element',
                            elementType: element.type
                        }));
                        e.target.classList.add('dragging');
                    });
                    
                    itemDiv.addEventListener('dragend', (e) => {
                        log(`dragend fired on: ${element.label}`, 'info');
                        e.target.classList.remove('dragging');
                    });
                    
                    categoryDiv.appendChild(itemDiv);
                });
                
                container.appendChild(categoryDiv);
            }
            
            log('Test elements initialized', 'success');
            testElements();
        }
        
        // Setup drop zone
        function setupDropZone() {
            const dropZone = document.getElementById('canvas-drop-zone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
                dropZone.classList.add('drag-over');
                log('dragover on drop zone', 'info');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                if (e.target === dropZone) {
                    dropZone.classList.remove('drag-over');
                    log('dragleave from drop zone', 'info');
                }
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    log(`DROP SUCCESSFUL: element type = ${data.elementType}`, 'success');
                } catch (error) {
                    log(`DROP ERROR: ${error.message}`, 'error');
                }
            });
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            log('Page loaded, initializing...', 'info');
            initializeTestElements();
            setupDropZone();
        });
    </script>
</body>
</html>
