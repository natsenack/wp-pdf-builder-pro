<!DOCTYPE html>
<html>
<head>
    <title>Test Remplacement wp.preferences</title>
</head>
<body>
    <h1>Test du remplacement wp.preferences</h1>
    <div id="results"></div>

    <script>
    // Simuler l'environnement WordPress de base
    window.wp = window.wp || {};

    // Simuler PDFEditorPreferences
    window.PDFEditorPreferences = {
        getPreference: function(key, defaultValue) {
            console.log('PDFEditorPreferences.getPreference:', key);
            return localStorage.getItem('pdf_pref_' + key) || defaultValue;
        },
        setPreference: function(key, value) {
            console.log('PDFEditorPreferences.setPreference:', key, value);
            localStorage.setItem('pdf_pref_' + key, value);
        },
        savePreferences: function() {
            console.log('PDFEditorPreferences.savePreferences');
            return Promise.resolve(true);
        },
        getAllPreferences: function() {
            console.log('PDFEditorPreferences.getAllPreferences');
            return { test: 'value' };
        }
    };

    // Charger notre script de remplacement
    var script = document.createElement('script');
    script.textContent = `
    // REMPLACEMENT COMPLET DE WP-PREFERENCES - approche agressive
    (function() {
        'use strict';

        console.log('[PDF Builder] Remplacement wp-preferences activé');

        // Fonction pour remplacer wp.preferences
        function replaceWpPreferences() {
            if (typeof window.wp === 'undefined') {
                window.wp = {};
            }

            // Remplacement complet de wp.preferences
            window.wp.preferences = {
                // Méthodes principales
                get: function(key, defaultValue) {
                    console.log('[PDF Builder] wp.preferences.get appelé:', key);
                    // Utiliser notre système de préférences personnalisé
                    if (typeof window.PDFEditorPreferences !== 'undefined') {
                        return window.PDFEditorPreferences.getPreference(key, defaultValue);
                    }
                    return defaultValue;
                },

                set: function(key, value) {
                    console.log('[PDF Builder] wp.preferences.set appelé:', key, value);
                    // Utiliser notre système de préférences personnalisé
                    if (typeof window.PDFEditorPreferences !== 'undefined') {
                        window.PDFEditorPreferences.setPreference(key, value);
                        return window.PDFEditorPreferences.savePreferences();
                    }
                    return Promise.resolve(false);
                },

                request: function() {
                    console.log('[PDF Builder] wp.preferences.request appelé - bloqué');
                    // Retourner une promesse résolue vide
                    return Promise.resolve({});
                },

                // Autres méthodes pour compatibilité
                getAll: function() {
                    console.log('[PDF Builder] wp.preferences.getAll appelé');
                    if (typeof window.PDFEditorPreferences !== 'undefined') {
                        return window.PDFEditorPreferences.getAllPreferences();
                    }
                    return {};
                },

                save: function() {
                    console.log('[PDF Builder] wp.preferences.save appelé');
                    if (typeof window.PDFEditorPreferences !== 'undefined') {
                        return window.PDFEditorPreferences.savePreferences();
                    }
                    return Promise.resolve(false);
                }
            };
        }

        // Remplacer immédiatement
        replaceWpPreferences();

        // Surveiller et remplacer en continu (au cas où wp-preferences se charge après)
        var checkInterval = setInterval(function() {
            if (window.wp && window.wp.preferences && typeof window.wp.preferences.get !== 'function') {
                console.log('[PDF Builder] wp.preferences détecté et remplacé');
                replaceWpPreferences();
            }
        }, 100);

        // Arrêter la surveillance après 10 secondes
        setTimeout(function() {
            clearInterval(checkInterval);
        }, 10000);

        console.log('[PDF Builder] Remplacement wp-preferences terminé');

    })();
    `;
    document.head.appendChild(script);

    // Tester après un délai
    setTimeout(function() {
        var results = document.getElementById('results');

        // Test 1: Vérifier que wp.preferences existe
        results.innerHTML += '<h2>Test 1: Existence de wp.preferences</h2>';
        if (typeof window.wp !== 'undefined' && typeof window.wp.preferences !== 'undefined') {
            results.innerHTML += '<p style="color: green;">✓ window.wp.preferences existe</p>';
        } else {
            results.innerHTML += '<p style="color: red;">✗ window.wp.preferences n\'existe pas</p>';
        }

        // Test 2: Tester la méthode get
        results.innerHTML += '<h2>Test 2: Méthode get</h2>';
        try {
            var value = window.wp.preferences.get('test_key', 'default_value');
            results.innerHTML += '<p style="color: green;">✓ get() fonctionne: ' + value + '</p>';
        } catch(e) {
            results.innerHTML += '<p style="color: red;">✗ get() échoue: ' + e.message + '</p>';
        }

        // Test 3: Tester la méthode set
        results.innerHTML += '<h2>Test 3: Méthode set</h2>';
        try {
            var promise = window.wp.preferences.set('test_key', 'test_value');
            if (promise && typeof promise.then === 'function') {
                results.innerHTML += '<p style="color: green;">✓ set() retourne une promesse</p>';
            } else {
                results.innerHTML += '<p style="color: orange;">⚠ set() ne retourne pas une promesse</p>';
            }
        } catch(e) {
            results.innerHTML += '<p style="color: red;">✗ set() échoue: ' + e.message + '</p>';
        }

        // Test 4: Tester request
        results.innerHTML += '<h2>Test 4: Méthode request</h2>';
        try {
            var reqPromise = window.wp.preferences.request();
            if (reqPromise && typeof reqPromise.then === 'function') {
                results.innerHTML += '<p style="color: green;">✓ request() retourne une promesse</p>';
            } else {
                results.innerHTML += '<p style="color: orange;">⚠ request() ne retourne pas une promesse</p>';
            }
        } catch(e) {
            results.innerHTML += '<p style="color: red;">✗ request() échoue: ' + e.message + '</p>';
        }

        results.innerHTML += '<h2>Console Logs</h2><p>Ouvrez la console du navigateur pour voir les logs détaillés.</p>';

    }, 2000);
    </script>
</body>
</html>