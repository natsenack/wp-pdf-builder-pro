# Nginx rate limiting configuration for WordPress/WooCommerce - Enhanced Version
# Add this to your nginx server block

# Rate limiting zones - More generous limits
limit_req_zone $binary_remote_addr zone=threeaxe.fr:10m rate=15r/s;
limit_req_zone $binary_remote_addr zone=admin:10m rate=8r/s;
limit_req_zone $binary_remote_addr zone=ajax:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=wc_api:10m rate=10r/s;

# Apply rate limiting
location / {
    limit_req zone=threeaxe.fr burst=30 nodelay;
    try_files $uri $uri/ /index.php?$args;
}

# Stricter limits for admin area
location /wp-admin/ {
    limit_req zone=admin burst=15 nodelay;
    try_files $uri $uri/ /index.php?$args;
}

# Limits for AJAX calls
location /wp-admin/admin-ajax.php {
    limit_req zone=ajax burst=8 nodelay;
    try_files $uri $uri/ /index.php?$args;
}

# Generous limits for WooCommerce API (admin operations)
location ~ ^/wp-json/wc-(analytics|admin)/ {
    limit_req zone=wc_api burst=20 nodelay;
    try_files $uri $uri/ /index.php?$args;
}

# Allow WooCommerce API with reasonable limits
location /wp-json/ {
    limit_req zone=threeaxe.fr burst=25 nodelay;
    try_files $uri $uri/ /index.php?$args;
}

# Block xmlrpc attacks
location /xmlrpc.php {
    deny all;
}

# Allow WordPress API with reasonable limits
location /wp-json/wp/ {
    limit_req zone=threeaxe.fr burst=20 nodelay;
    try_files $uri $uri/ /index.php?$args;
}

# Static assets - higher limits
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    limit_req zone=threeaxe.fr burst=50 nodelay;
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri $uri/ /index.php?$args;
}