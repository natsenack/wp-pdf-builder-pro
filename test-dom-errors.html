<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test DOM Errors - PDF Builder Pro</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #console-output { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test des Erreurs DOM - PDF Builder Pro</h1>

    <div class="test-section">
        <h3>Test 1: V√©rification des Hooks DOM</h3>
        <p>Cette page teste si les corrections DOM fonctionnent correctement.</p>
        <button onclick="testDOMValidation()">Tester la validation DOM</button>
        <button onclick="clearConsole()">Effacer la console</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 2: Simulation d'interactions Canvas</h3>
        <p>Simule les interactions qui causaient les erreurs removeChild.</p>
        <button onclick="simulateCanvasInteractions()">Simuler les interactions</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h3>Console de d√©bogage</h3>
        <div id="console-output"></div>
    </div>

    <script>
        let originalConsoleLog = console.log;
        let originalConsoleWarn = console.warn;
        let originalConsoleError = console.error;
        let consoleOutput = [];

        // Intercepter les messages console
        console.log = function(...args) {
            consoleOutput.push('[LOG] ' + args.join(' '));
            originalConsoleLog.apply(console, args);
            updateConsole();
        };

        console.warn = function(...args) {
            consoleOutput.push('[WARN] ' + args.join(' '));
            originalConsoleWarn.apply(console, args);
            updateConsole();
        };

        console.error = function(...args) {
            consoleOutput.push('[ERROR] ' + args.join(' '));
            originalConsoleError.apply(console, args);
            updateConsole();
        };

        function updateConsole() {
            document.getElementById('console-output').textContent = consoleOutput.slice(-20).join('\n');
        }

        function clearConsole() {
            consoleOutput = [];
            updateConsole();
        }

        function testDOMValidation() {
            const resultDiv = document.getElementById('test1-result');

            try {
                // Simuler la v√©rification DOM comme dans nos hooks
                const testElement = document.createElement('div');
                document.body.appendChild(testElement);

                // Test 1: √âl√©ment connect√©
                if (testElement.isConnected) {
                    console.log('‚úÖ Test 1 pass√©: √âl√©ment connect√© d√©tect√©');
                } else {
                    console.error('‚ùå Test 1 √©chou√©: √âl√©ment connect√© non d√©tect√©');
                }

                // Test 2: Parent connect√©
                if (testElement.parentNode && testElement.parentNode.isConnected) {
                    console.log('‚úÖ Test 2 pass√©: Parent connect√© d√©tect√©');
                } else {
                    console.error('‚ùå Test 2 √©chou√©: Parent connect√© non d√©tect√©');
                }

                // Test 3: Suppression et v√©rification
                const removedElement = testElement;
                document.body.removeChild(testElement);

                if (!removedElement.isConnected) {
                    console.log('‚úÖ Test 3 pass√©: √âl√©ment d√©connect√© d√©tect√© apr√®s suppression');
                } else {
                    console.error('‚ùå Test 3 √©chou√©: √âl√©ment toujours connect√© apr√®s suppression');
                }

                resultDiv.innerHTML = '<span class="success">‚úÖ Tests de validation DOM termin√©s</span>';

            } catch (error) {
                console.error('‚ùå Erreur lors des tests DOM:', error);
                resultDiv.innerHTML = '<span class="error">‚ùå Erreur lors des tests: ' + error.message + '</span>';
            }
        }

        function simulateCanvasInteractions() {
            const resultDiv = document.getElementById('test2-result');

            try {
                // Simuler la cr√©ation d'√©l√©ments canvas comme dans React
                const canvasContainer = document.createElement('div');
                canvasContainer.id = 'canvas-container';
                document.body.appendChild(canvasContainer);

                // Simuler des √©l√©ments avec des poign√©es de redimensionnement
                for (let i = 0; i < 3; i++) {
                    const element = document.createElement('div');
                    element.className = 'canvas-element';
                    element.id = `element-${i}`;
                    element.style.cssText = 'position: absolute; left: ' + (i * 100) + 'px; top: 50px; width: 80px; height: 60px; background: #007cba; border: 2px solid #005a87;';

                    // Ajouter des poign√©es de redimensionnement avec cl√©s stables
                    const handles = ['nw', 'ne', 'sw', 'se'];
                    handles.forEach(handle => {
                        const handleDiv = document.createElement('div');
                        handleDiv.className = `resize-handle resize-${handle}`;
                        handleDiv.setAttribute('data-key', `handle-${i}-${handle}`); // Cl√© stable
                        handleDiv.style.cssText = 'position: absolute; width: 8px; height: 8px; background: #fff; border: 1px solid #000; cursor: ' + handle + '-resize;';
                        element.appendChild(handleDiv);
                    });

                    canvasContainer.appendChild(element);
                }

                console.log('‚úÖ √âl√©ments canvas cr√©√©s avec poign√©es de redimensionnement');

                // Simuler une s√©lection/d√©s√©lection rapide (cause des erreurs removeChild)
                setTimeout(() => {
                    try {
                        const elements = document.querySelectorAll('.canvas-element');
                        elements.forEach((element, index) => {
                            if (index % 2 === 0) {
                                // Simuler la suppression des poign√©es (comme lors de la d√©s√©lection)
                                const handles = element.querySelectorAll('.resize-handle');
                                handles.forEach(handle => {
                                    if (handle.parentNode) {
                                        element.removeChild(handle);
                                    }
                                });
                                console.log(`‚úÖ Poign√©es supprim√©es pour l'√©l√©ment ${index}`);
                            }
                        });

                        resultDiv.innerHTML = '<span class="success">‚úÖ Simulation d\'interactions canvas termin√©e sans erreurs DOM</span>';

                    } catch (error) {
                        console.error('‚ùå Erreur lors de la simulation:', error);
                        resultDiv.innerHTML = '<span class="error">‚ùå Erreur lors de la simulation: ' + error.message + '</span>';
                    }
                }, 100);

                // Nettoyer apr√®s 2 secondes
                setTimeout(() => {
                    if (canvasContainer.parentNode) {
                        document.body.removeChild(canvasContainer);
                        console.log('üßπ Nettoyage termin√©');
                    }
                }, 2000);

            } catch (error) {
                console.error('‚ùå Erreur lors de la simulation:', error);
                resultDiv.innerHTML = '<span class="error">‚ùå Erreur lors de la simulation: ' + error.message + '</span>';
            }
        }

        // Test automatique au chargement
        window.addEventListener('load', () => {
            console.log('üöÄ Test DOM Errors - PDF Builder Pro charg√©');
            console.log('üîß Corrections appliqu√©es:');
            console.log('   - V√©rifications DOM dans useResize.js et useDragAndDrop.js');
            console.log('   - Cl√©s stables pour les poign√©es de redimensionnement');
            console.log('   - Validation des √©l√©ments avant manipulation');
        });
    </script>
</body>
</html>