<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Transformations & Grid - Fixed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .toolbar {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #e9ecef;
        }
        button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        #canvas-container {
            border: 2px solid #dee2e6;
            border-radius: 5px;
            background: white;
            position: relative;
            margin-bottom: 20px;
        }
        #pdf-builder-canvas {
            display: block;
            cursor: default;
        }
        .status {
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
        }
        .test-results.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª Test Transformations & Grid - Fixed</h1>

        <div class="toolbar">
            <div class="control-group">
                <button id="add-rect">Add Rectangle</button>
                <button id="add-text">Add Text</button>
                <button id="clear">Clear All</button>
            </div>
            <div class="control-group">
                <button id="toggle-grid">Toggle Grid</button>
                <button id="test-transform">Test Transform</button>
                <button id="test-precision">Test Precision</button>
            </div>
        </div>

        <div id="canvas-container">
            <canvas id="pdf-builder-canvas" width="1000" height="600"></canvas>
        </div>

        <div class="status" id="status">
            Status: Initializing...<br>
            Grid: <span id="grid-status">Unknown</span><br>
            Elements: <span id="elements-count">0</span><br>
            Selected: <span id="selected-element">None</span><br>
            Mode: <span id="current-mode">select</span>
        </div>

        <div class="test-results" id="test-results">
            <strong>Test Results:</strong><br>
            <div id="test-output">Running tests...</div>
        </div>
    </div>

    <script src="/assets/js/src/pdf-builder-vanilla-bundle.js"></script>
    <script>
        let pdfCanvas;
        let testResults = [];

        // Initialize canvas when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('ðŸš€ Initializing test canvas...');

                // Initialize the canvas
                pdfCanvas = window.pdfBuilderInitVanilla('canvas-container', {
                    canvasElementId: 'pdf-builder-canvas',
                    width: 1000,
                    height: 600,
                    showGrid: true,
                    gridSize: 20
                });

                console.log('âœ… Canvas initialized successfully');
                updateStatus();

                // Setup event listeners
                setupControls();

                // Run initial tests
                runInitialTests();

            } catch (error) {
                console.error('âŒ Failed to initialize canvas:', error);
                document.getElementById('status').innerHTML = 'âŒ Error: ' + error.message;
                document.getElementById('test-results').className = 'test-results error';
                document.getElementById('test-output').textContent = 'âŒ Initialization failed: ' + error.message;
            }
        });

        function setupControls() {
            // Add rectangle
            document.getElementById('add-rect').addEventListener('click', () => {
                if (pdfCanvas) {
                    const elementId = pdfCanvas.addElement('rectangle', {
                        x: Math.random() * 400 + 50,
                        y: Math.random() * 300 + 50,
                        width: 120,
                        height: 80,
                        backgroundColor: '#007bff',
                        borderColor: '#0056b3',
                        borderWidth: 2
                    });
                    console.log('Added rectangle:', elementId);
                    updateStatus();
                }
            });

            // Add text
            document.getElementById('add-text').addEventListener('click', () => {
                if (pdfCanvas) {
                    const elementId = pdfCanvas.addElement('text', {
                        x: Math.random() * 400 + 100,
                        y: Math.random() * 300 + 100,
                        width: 150,
                        height: 40,
                        text: 'Test Text',
                        fontSize: 16,
                        color: '#333'
                    });
                    console.log('Added text:', elementId);
                    updateStatus();
                }
            });

            // Clear all
            document.getElementById('clear').addEventListener('click', () => {
                if (pdfCanvas) {
                    pdfCanvas.elements.clear();
                    pdfCanvas.selectionManager.clearSelection();
                    pdfCanvas.render();
                    console.log('Cleared all elements');
                    updateStatus();
                }
            });

            // Toggle grid
            document.getElementById('toggle-grid').addEventListener('click', () => {
                if (pdfCanvas) {
                    const gridEnabled = pdfCanvas.toggleGrid();
                    console.log('Grid toggled:', gridEnabled);
                    updateStatus();
                    document.getElementById('toggle-grid').classList.toggle('active', gridEnabled);
                }
            });

            // Test transform
            document.getElementById('test-transform').addEventListener('click', () => {
                testTransformations();
            });

            // Test precision
            document.getElementById('test-precision').addEventListener('click', () => {
                testPrecision();
            });
        }

        function updateStatus() {
            if (!pdfCanvas) return;

            const gridStatus = pdfCanvas.options.showGrid ? 'âœ… Enabled' : 'âŒ Disabled';
            const elementsCount = pdfCanvas.elements.size;
            const selectedElement = pdfCanvas.selectedElement ? pdfCanvas.selectedElement.id : 'None';
            const currentMode = pdfCanvas.mode || 'select';

            document.getElementById('grid-status').textContent = gridStatus;
            document.getElementById('elements-count').textContent = elementsCount;
            document.getElementById('selected-element').textContent = selectedElement;
            document.getElementById('current-mode').textContent = currentMode;
        }

        function runInitialTests() {
            testResults = [];

            // Test 1: Check if instance exists
            if (typeof pdfCanvas !== 'undefined' && pdfCanvas !== null) {
                testResults.push('âœ… pdfCanvas instance exists');
            } else {
                testResults.push('âŒ pdfCanvas instance missing');
            }

            // Test 2: Check if grid API exists
            if (typeof pdfCanvas.toggleGrid === 'function') {
                testResults.push('âœ… toggleGrid method exists');
            } else {
                testResults.push('âŒ toggleGrid method missing');
            }

            // Test 3: Check if setGrid API exists
            if (typeof pdfCanvas.setGrid === 'function') {
                testResults.push('âœ… setGrid method exists');
            } else {
                testResults.push('âŒ setGrid method missing');
            }

            // Test 4: Check coordinate system
            if (typeof pdfCanvas.getMousePosition === 'function') {
                testResults.push('âœ… getMousePosition method exists');
            } else {
                testResults.push('âŒ getMousePosition method missing');
            }

            // Test 5: Check transformations manager
            if (pdfCanvas.transformationsManager) {
                testResults.push('âœ… transformationsManager exists');
            } else {
                testResults.push('âŒ transformationsManager missing');
            }

            // Test 6: Check renderer
            if (pdfCanvas.renderer) {
                testResults.push('âœ… renderer exists');
            } else {
                testResults.push('âŒ renderer missing');
            }

            // Test 7: Check selection manager
            if (pdfCanvas.selectionManager) {
                testResults.push('âœ… selectionManager exists');
            } else {
                testResults.push('âŒ selectionManager missing');
            }

            // Test 8: Check grid is enabled by default
            if (pdfCanvas.options.showGrid === true) {
                testResults.push('âœ… Grid enabled by default');
            } else {
                testResults.push('âŒ Grid not enabled by default');
            }

            console.log('Initial tests completed:', testResults);
            updateTestResults();
        }

        function testTransformations() {
            console.log('ðŸ§ª Testing transformations...');

            if (!pdfCanvas || pdfCanvas.elements.size === 0) {
                alert('Please add an element first');
                return;
            }

            const element = Array.from(pdfCanvas.elements.values())[0];
            console.log('Testing with element:', element);

            // Test 1: Select element
            pdfCanvas.selectionManager.selectAtPoint({
                x: element.properties.x + element.properties.width / 2,
                y: element.properties.y + element.properties.height / 2
            }, false);

            updateStatus();

            // Test 2: Check if handles are detected
            const handles = pdfCanvas.transformationsManager.getResizeHandles(element.properties);
            console.log('Element handles:', handles);

            let handleCount = Object.keys(handles).length;
            if (handleCount === 8) {
                testResults.push('âœ… All 8 resize handles detected');
            } else {
                testResults.push(`âŒ Expected 8 handles, got ${handleCount}`);
            }

            // Test 3: Test handle detection at specific points
            const testPoints = [
                { pos: 'nw', point: { x: handles.nw.x, y: handles.nw.y } },
                { pos: 'se', point: { x: handles.se.x, y: handles.se.y } },
                { pos: 'n', point: { x: handles.n.x, y: handles.n.y } }
            ];

            testPoints.forEach(({ pos, point }) => {
                const handle = pdfCanvas.transformationsManager.getHandleAtPoint(point, element);
                if (handle && handle.position === pos) {
                    testResults.push(`âœ… Handle ${pos} correctly detected`);
                } else {
                    testResults.push(`âŒ Handle ${pos} not detected correctly`);
                }
            });

            updateTestResults();
            alert('Transformation tests completed. Check console and test results.');
        }

        function testPrecision() {
            console.log('ðŸ§ª Testing precision...');

            if (!pdfCanvas || pdfCanvas.elements.size === 0) {
                alert('Please add an element first');
                return;
            }

            const element = Array.from(pdfCanvas.elements.values())[0];
            const originalProps = { ...element.properties };

            console.log('Original element properties:', originalProps);

            // Test resize simulation
            const testResize = (handlePos, deltaX, deltaY, expectedChange) => {
                // Simulate start transform
                const handle = { type: 'resize', position: handlePos, element: element, x: 0, y: 0 };
                pdfCanvas.transformationsManager.startTransform({ x: 100, y: 100 }, handle);

                // Simulate update transform
                pdfCanvas.transformationsManager.updateTransform({ x: 100 + deltaX, y: 100 + deltaY });

                // Check result
                const newProps = element.properties;
                console.log(`Resize ${handlePos} (${deltaX}, ${deltaY}):`, newProps);

                // Reset for next test
                Object.assign(element.properties, originalProps);
            };

            // Test various resize operations
            testResize('se', 50, 30, 'width +50, height +30');
            testResize('nw', -20, -15, 'x -20, y -15, width +20, height +15');
            testResize('e', 40, 0, 'width +40');
            testResize('n', 0, -25, 'y -25, height +25');

            // End transform
            pdfCanvas.transformationsManager.endTransform();

            testResults.push('âœ… Precision tests completed - check console for details');
            updateTestResults();

            alert('Precision tests completed. Check console for detailed results.');
        }

        function updateTestResults() {
            const output = document.getElementById('test-output');
            output.innerHTML = testResults.join('<br>');
        }

        // Update status periodically
        setInterval(updateStatus, 1000);
    </script>
</body>
</html>